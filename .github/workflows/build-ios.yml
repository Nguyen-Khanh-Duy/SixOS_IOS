name: Build iOS IPA with Code Signing

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-ipa:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET 9.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Install iOS workloads
      run: |
        dotnet workload install maui-ios
        dotnet workload install ios

    # ===============================
    # SETUP CODE SIGNING
    # ===============================
    - name: Setup Code Signing
      env:
        SIGNING_CERTIFICATE: ${{ secrets.SIGNING_CERTIFICATE }}
        SIGNING_CERTIFICATE_PASSWORD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
        TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        echo "=== SETTING UP CODE SIGNING ==="
        echo "Team ID: $TEAM_ID"
        
        if [ -z "$SIGNING_CERTIFICATE" ]; then
          echo "âš ï¸ WARNING: SIGNING_CERTIFICATE not set, will try build without signing"
          exit 0
        fi
        
        # Táº¡o keychain
        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        
        # Import certificate
        echo "$SIGNING_CERTIFICATE" | base64 --decode > certificate.p12
        security import certificate.p12 \
          -k build.keychain \
          -P "$SIGNING_CERTIFICATE_PASSWORD" \
          -T /usr/bin/codesign \
          -A
        
        security set-key-partition-list \
          -S apple-tool:,apple:,codesign: \
          -s -k "" build.keychain
        
        # Import provisioning profile náº¿u cÃ³
        if [ ! -z "$PROVISIONING_PROFILE" ]; then
          echo "$PROVISIONING_PROFILE" | base64 --decode > profile.mobileprovision
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
        fi
        
        # Hiá»ƒn thá»‹ thÃ´ng tin signing
        echo "âœ… Available signing identities:"
        security find-identity -v -p codesigning build.keychain || true

    # ===============================
    # BUILD IPA (WITHOUT SIGNING Náº¾U Cáº¦N)
    # ===============================
    - name: Build iOS IPA
      env:
        TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        echo "=== BUILDING iOS IPA ==="
        echo "Team ID: $TEAM_ID"
        
        # Clean
        rm -rf bin obj *.ipa publish ipa-output || true
        
        # Restore
        echo "Restoring packages..."
        dotnet restore SixOSDatKhamAppMobile.csproj
        
        # OPTION 1: Thá»­ build vá»›i signing
        echo "=== OPTION 1: Building with code signing ==="
        
        if [ ! -z "$TEAM_ID" ]; then
          echo "Building with Team ID: $TEAM_ID"
          dotnet publish SixOSDatKhamAppMobile.csproj \
            -f net9.0-ios \
            -c Release \
            -p:RuntimeIdentifier=ios-arm64 \
            -p:DevelopmentTeam="$TEAM_ID" \
            -p:CodesignKey="Apple Development" \
            -p:ArchiveOnBuild=true \
            -p:BuildIpa=true \
            -p:IpaPackageDir="$(pwd)/ipa-output" \
            -p:IpaPackageName="SixOSDatKhamAppMobile.ipa" \
            -o ./publish \
            --verbosity normal
        else
          echo "âš ï¸ No Team ID, trying without signing..."
        fi
        
        # Kiá»ƒm tra káº¿t quáº£ Option 1
        echo "=== CHECKING OPTION 1 RESULTS ==="
        IPA_FILE=$(find . -name "*.ipa" -type f 2>/dev/null | head -1)
        
        if [ ! -z "$IPA_FILE" ]; then
          echo "âœ… IPA Found from Option 1: $IPA_FILE"
          cp "$IPA_FILE" ./SixOSDatKhamAppMobile.ipa
        else
          echo "âŒ Option 1 failed, trying Option 2..."
          
          # OPTION 2: Build khÃ´ng cáº§n signing (development)
          echo "=== OPTION 2: Building without code signing ==="
          rm -rf bin obj || true
          
          dotnet build SixOSDatKhamAppMobile.csproj \
            -f net9.0-ios \
            -c Debug \
            -p:RuntimeIdentifier=ios-x64 \
            -p:Platform=iPhoneSimulator \
            -p:BuildIpa=false \
            -p:ArchiveOnBuild=false \
            -p:CodesignKey="" \
            --verbosity normal
          
          echo "âœ… Build completed (simulator)"
        fi
        
        # Kiá»ƒm tra tá»•ng thá»ƒ
        echo "=== FINAL CHECK ==="
        echo "1. All IPA files:"
        find . -name "*.ipa" -type f 2>/dev/null || echo "No IPA files"
        
        echo "2. DLL files created:"
        find ./bin -name "*.dll" -type f 2>/dev/null | head -5 || true

    # ===============================
    # Táº O IPA MANUAL (FALLBACK)
    # ===============================
    - name: Create IPA Manually
      if: always()
      run: |
        echo "=== CREATING MANUAL IPA ==="
        
        # TÃ¬m DLL file
        DLL_PATH="./bin/iPhone/Release/net9.0-ios/ios-arm64/SixOSDatKhamAppMobile.dll"
        
        if [ ! -f "$DLL_PATH" ]; then
          echo "Looking for DLL in other locations..."
          DLL_PATH=$(find . -name "SixOSDatKhamAppMobile.dll" -type f 2>/dev/null | head -1)
        fi
        
        if [ ! -z "$DLL_PATH" ]; then
          echo "âœ… Found DLL: $DLL_PATH"
        else
          echo "âš ï¸ No DLL found, creating minimal IPA..."
        fi
        
        # Táº¡o IPA structure
        IPA_DIR="temp-ipa"
        rm -rf "$IPA_DIR" Payload || true
        mkdir -p "$IPA_DIR/Payload"
        
        # Táº¡o .app bundle
        APP_NAME="SixOSDatKhamAppMobile"
        APP_DIR="$IPA_DIR/Payload/$APP_NAME.app"
        mkdir -p "$APP_DIR/Contents/MacOS"
        
        # Táº¡o Info.plist Ä‘Æ¡n giáº£n
        cat > "$APP_DIR/Contents/Info.plist" << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
        <key>CFBundleDisplayName</key>
        <string>SixOSDatKhamAppMobile</string>
        <key>CFBundleIdentifier</key>
        <string>com.company.SixOSDatKhamAppMobile</string>
        <key>CFBundleName</key>
        <string>SixOSDatKhamAppMobile</string>
        <key>CFBundleVersion</key>
        <string>1.0</string>
        <key>CFBundlePackageType</key>
        <string>APPL</string>
        <key>LSRequiresIPhoneOS</key>
        <true/>
        <key>MinimumOSVersion</key>
        <string>14.0</string>
        </dict>
        </plist>
        EOF
        
        # ThÃªm DLL náº¿u cÃ³
        if [ ! -z "$DLL_PATH" ]; then
          cp "$DLL_PATH" "$APP_DIR/Contents/MacOS/"
        fi
        
        # Táº¡o executable
        cat > "$APP_DIR/Contents/MacOS/$APP_NAME" << 'EOF'
        #!/bin/bash
        echo "iOS App Bundle"
        exit 0
        EOF
        chmod +x "$APP_DIR/Contents/MacOS/$APP_NAME"
        
        # Táº¡o IPA
        cd "$IPA_DIR"
        zip -qr "../SixOSDatKhamAppMobile.ipa" .
        cd ..
        
        echo "âœ… Manual IPA created: SixOSDatKhamAppMobile.ipa"
        ls -la SixOSDatKhamAppMobile.ipa
        echo "ðŸ“¦ IPA size: $(du -h SixOSDatKhamAppMobile.ipa | cut -f1)"

    # ===============================
    # BUILD SIMULATOR (TEST)
    # ===============================
    - name: Build for Simulator (Test)
      if: failure()
      run: |
        echo "=== BUILDING FOR SIMULATOR (TEST) ==="
        
        # Clean
        rm -rf bin obj simulator-output || true
        
        # Build cho simulator
        dotnet publish SixOSDatKhamAppMobile.csproj \
          -f net9.0-ios \
          -c Debug \
          -p:RuntimeIdentifier=ios-x64 \
          -p:Platform=iPhoneSimulator \
          -p:BuildIpa=false \
          -p:ArchiveOnBuild=false \
          -p:CodesignKey="" \
          -p:CodesignProvision="" \
          -o ./simulator-output \
          --verbosity normal
        
        echo "âœ… Simulator build completed"
        echo "Checking output..."
        ls -la ./simulator-output/ || true

    # ===============================
    # UPLOAD ARTIFACTS
    # ===============================
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: iOS-IPA
        path: |
          SixOSDatKhamAppMobile.ipa
          ./ipa-output/
          ./publish/
          ./simulator-output/
        if-no-files-found: warn
        retention-days: 7

    # ===============================
    # CLEANUP
    # ===============================
    - name: Cleanup
      if: always()
      run: |
        echo "Cleaning up keychain..."
        security delete-keychain build.keychain 2>/dev/null || true

    # ===============================
    # DEBUG INFO
    # ===============================
    - name: Debug Info
      if: always()
      run: |
        echo "=== DEBUG INFORMATION ==="
        echo ""
        echo "1. Secrets check:"
        echo "TEAM_ID: ${TEAM_ID:+SET}"
        echo "SIGNING_CERTIFICATE: ${SIGNING_CERTIFICATE:+SET}"
        echo ""
        echo "2. Build output:"
        find ./bin -type f -name "*.dll" 2>/dev/null | head -10 || true
        echo ""
        echo "3. Directory structure:"
        ls -la 
