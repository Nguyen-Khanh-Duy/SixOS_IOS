name: Build iOS IPA

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-ipa:
    runs-on: macos-latest

    steps:
    # ===============================
    # CHECKOUT
    # ===============================
    - name: Checkout code
      uses: actions/checkout@v4

    # ===============================
    # SETUP .NET 9
    # ===============================
    - name: Setup .NET 9
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.200'

    - name: Install MAUI iOS workload
      run: |
        dotnet workload install maui-ios --source https://api.nuget.org/v3/index.json
        dotnet workload install ios --source https://api.nuget.org/v3/index.json

    # ===============================
    # SETUP CODE SIGNING
    # ===============================
    - name: Setup Code Signing
      env:
        SIGNING_CERTIFICATE: ${{ secrets.SIGNING_CERTIFICATE }}
        SIGNING_CERTIFICATE_PASSWORD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
      run: |
        echo "üîê Setting up signing..."

        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain

        echo "$SIGNING_CERTIFICATE" | base64 --decode > certificate.p12
        security import certificate.p12 \
          -k build.keychain \
          -P "$SIGNING_CERTIFICATE_PASSWORD" \
          -T /usr/bin/codesign \
          -A

        security set-key-partition-list \
          -S apple-tool:,apple:,codesign: \
          -s -k "" build.keychain
        security set-keychain-settings -t 3600 -l ~/Library/Keychains/build.keychain

        echo "$PROVISIONING_PROFILE" | base64 --decode > profile.mobileprovision
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

        echo "‚úÖ Available identities:"
        security find-identity -v -p codesigning
        
        echo "\nüì± Provisioning profiles:"
        ls -la ~/Library/MobileDevice/Provisioning\ Profiles/

    # ===============================
    # FIX: C·∫¨P NH·∫¨T CSPROJ
    # ===============================
    - name: Update csproj for iOS build
      run: |
        echo "üìù ƒê·∫£m b·∫£o csproj c√≥ c·∫•u h√¨nh iOS ƒë√∫ng..."
        # Th√™m c√°c thu·ªôc t√≠nh c·∫ßn thi·∫øt v√†o csproj n·∫øu ch∆∞a c√≥

    # ===============================
    # BUILD IPA - C√ÅCH 1: S·ª¨ D·ª§NG MSBUILD
    # ===============================
    - name: Build IPA with MSBuild
      run: |
        echo "üöÄ Building IPA with MSBuild..."
        
        # Clean
        dotnet clean SixOSDatKhamAppMobile.csproj -c Release
        
        # Restore
        dotnet restore SixOSDatKhamAppMobile.csproj
        
        # Build v·ªõi MSBuild tr·ª±c ti·∫øp
        msbuild SixOSDatKhamAppMobile.csproj \
            /p:Configuration=Release \
            /p:Platform=iPhone \
            /p:RuntimeIdentifier=ios-arm64 \
            /p:BuildIpa=true \
            /p:CodesignKey="Apple Distribution" \
            /p:CodesignProvision="iOS Team Provisioning Profile: *" \
            /p:DevelopmentTeam="2DQG584W52" \
            /p:ArchiveOnBuild=true \
            /t:Publish \
            /verbosity:normal

    # ===============================
    # BUILD IPA - C√ÅCH 2: T·∫†O APP TR∆Ø·ªöC, SAU ƒê√ì T·∫†O IPA
    # ===============================
    - name: Build .app and create IPA
      run: |
        echo "üì± Building .app bundle..."
        
        # T·∫°o th∆∞ m·ª•c output
        mkdir -p artifacts
        
        # Build t·∫°o .app
        dotnet publish SixOSDatKhamAppMobile.csproj \
            -f net9.0-ios \
            -c Release \
            -r ios-arm64 \
            -p:ArchiveOnBuild=false \
            -p:BuildIpa=false \
            -o artifacts/app
        
        echo "‚úÖ Build completed. Checking output:"
        ls -la artifacts/
        ls -la artifacts/app/ || true
        
        # T√¨m .app bundle
        APP_BUNDLE=$(find artifacts -name "*.app" -type d | head -1)
        
        if [ -n "$APP_BUNDLE" ]; then
          echo "‚úÖ Found .app at: $APP_BUNDLE"
          
          # T·∫°o c·∫•u tr√∫c Payload v√† IPA
          mkdir -p Payload
          cp -r "$APP_BUNDLE" Payload/
          
          # Codesign l·∫°i n·∫øu c·∫ßn
          codesign -f -s "Apple Distribution" -v Payload/*.app --deep
          
          # T·∫°o IPA
          zip -r SixOSDatKhamApp.ipa Payload/
          
          echo "‚úÖ Created IPA: SixOSDatKhamApp.ipa"
          ls -la *.ipa
          
          # Copy v√†o th∆∞ m·ª•c output
          mkdir -p ipa-output
          cp *.ipa ipa-output/
        else
          echo "‚ùå No .app bundle found!"
          
          # T√¨m ki·∫øm t·∫•t c·∫£ file
          echo "Searching for any build artifacts:"
          find artifacts -type f | head -20
        fi

    # ===============================
    # C√ÅCH 3: T·∫†O IPA B·∫∞NG XCODEBUILD
    # ===============================
    - name: Create IPA using xcodebuild
      run: |
        echo "üèóÔ∏è Creating IPA using xcodebuild..."
        
        # T√¨m file .app
        APP_BUNDLE=$(find . -name "*.app" -type d | head -1)
        
        if [ -n "$APP_BUNDLE" ]; then
          APP_NAME=$(basename "$APP_BUNDLE" .app)
          echo "Found app: $APP_NAME"
          
          # T·∫°o archive
          mkdir -p archive
          xcodebuild -project "$APP_BUNDLE" \
            -scheme "$APP_NAME" \
            -configuration Release \
            -archivePath archive/$APP_NAME.xcarchive \
            archive || true
          
          # T·∫°o IPA t·ª´ archive
          mkdir -p ipa-output
          xcodebuild -exportArchive \
            -archivePath archive/$APP_NAME.xcarchive \
            -exportPath ipa-output \
            -exportOptionsPlist exportOptions.plist || true
          
          # N·∫øu kh√¥ng t·∫°o ƒë∆∞·ª£c, copy tr·ª±c ti·∫øp
          cp -r "$APP_BUNDLE" ipa-output/ || true
        fi

    # ===============================
    # T·∫†O EXPORT OPTIONS PLIST
    # ===============================
    - name: Create exportOptions.plist
      run: |
        cat > exportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>2DQG584W52</string>
            <key>signingCertificate</key>
            <string>Apple Distribution</string>
            <key>signingStyle</key>
            <string>manual</string>
        </dict>
        </plist>
        EOF

    # ===============================
    # T√åM V√Ä COPY IPA
    # ===============================
    - name: Find and copy IPA
      run: |
        echo "üîç Searching for IPA files..."
        
        # T·∫°o th∆∞ m·ª•c output n·∫øu ch∆∞a c√≥
        mkdir -p ipa-output
        
        # T√¨m IPA
        IPA_FILES=$(find . -name "*.ipa" -type f)
        
        if [ -n "$IPA_FILES" ]; then
          echo "‚úÖ Found IPA files:"
          echo "$IPA_FILES"
          cp $IPA_FILES ipa-output/ 2>/dev/null || true
        else
          echo "‚ùå No IPA files found"
          
          # T√¨m .app files
          APP_FILES=$(find . -name "*.app" -type d)
          if [ -n "$APP_FILES" ]; then
            echo "‚úÖ Found .app files:"
            echo "$APP_FILES"
            cp -r $APP_FILES ipa-output/ 2>/dev/null || true
          fi
        fi
        
        echo "\nüìÅ ipa-output contents:"
        ls -la ipa-output/ || echo "Empty"

    # ===============================
    # UPLOAD ARTIFACTS
    # ===============================
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: iOS-Build-${{ github.sha }}
        path: |
          ipa-output/
          **/*.ipa
          **/*.app
          **/*.dll
          artifacts/
        retention-days: 7
        if-no-files-found: warn

    # ===============================
    # DEBUG INFO
    # ===============================
    - name: Debug Info
      if: always()
      run: |
        echo "üìÇ Full directory structure:"
        find . -type f -name "*.ipa" -o -name "*.app" -o -name "*.dll" | head -30
        
        echo "\nüîß Build tools:"
        msbuild -version || true
        xcodebuild -version || true
