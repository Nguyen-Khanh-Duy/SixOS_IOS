name: Build iOS với .NET 7 MAUI

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout mã nguồn
      uses: actions/checkout@v4

    - name: Cài đặt .NET 7 SDK và workloads
      run: |
        # Cài .NET 7 SDK
        curl -L https://dot.net/v1/dotnet-install.sh | bash -s -- --version 7.0.403
        
        # Thêm vào PATH
        echo "export DOTNET_ROOT=$HOME/.dotnet" >> $GITHUB_ENV
        echo "export PATH=$HOME/.dotnet:$HOME/.dotnet/tools:$PATH" >> $GITHUB_ENV
        
        # Cài workloads MAUI
        $HOME/.dotnet/dotnet workload install maui-ios maui-maccatalyst
        $HOME/.dotnet/dotnet workload restore

    - name: Kiểm tra .NET
      run: dotnet --info

    - name: Build IPA iOS
      run: |
        dotnet publish SixOSDatKhamAppMobile.csproj \
          -f net7.0-ios \
          -c Release \
          -r ios-arm64 \
          -p:BuildIpa=true \
          -p:PublishTrimmed=true \
          -p:MtouchLink=SdkOnly \
          -p:TargetPlatformVersion=14.0 \
          -p:SupportedOSPlatformVersion=14.0 \
          -p:CodesignKey="iPhone Distribution" \
          -p:CodesignProvision="Automatic:Provisioning" \
          -p:ArchiveOnBuild=true \
          --verbosity detailed
