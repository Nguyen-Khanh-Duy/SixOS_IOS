name: Build iOS with Code Signing

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Install MAUI workloads
      run: |
        dotnet workload install maui
        dotnet workload install maui-ios

    - name: Debug Secrets
      env:
        SIGNING_CERTIFICATE: ${{ secrets.SIGNING_CERTIFICATE }}
        SIGNING_CERTIFICATE_PASSWORD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
        TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        echo "TEAM_ID: $TEAM_ID"
        
        if [ -z "$SIGNING_CERTIFICATE" ]; then
          echo "âŒ SIGNING_CERTIFICATE is empty!"
        else
          echo "âœ… SIGNING_CERTIFICATE is set"
        fi
        if [ -z "$PROVISIONING_PROFILE" ]; then
          echo "âŒ PROVISIONING_PROFILE is empty!"
        else
          echo "âœ… PROVISIONING_PROFILE is set"
        fi

    - name: Create keychain and import certificates
      env:
        SIGNING_CERTIFICATE: ${{ secrets.SIGNING_CERTIFICATE }}
        SIGNING_CERTIFICATE_PASSWORD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
      run: |
        set -e
        
        echo "âœ… Creating keychain..."
        
        # Create keychain
        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        
        # Import certificate
        echo "Importing certificate..."
        echo "$SIGNING_CERTIFICATE" | base64 --decode > certificate.p12
        security import certificate.p12 \
          -k build.keychain \
          -P "$SIGNING_CERTIFICATE_PASSWORD" \
          -T /usr/bin/codesign \
          -A
        
        security set-key-partition-list \
          -S apple-tool:,apple:,codesign: \
          -s -k "" build.keychain
        
        echo "ðŸ” Available signing identities:"
        security find-identity -v -p codesigning build.keychain || true
        
        # Import provisioning profile
        echo "Importing provisioning profile..."
        echo "$PROVISIONING_PROFILE" | base64 --decode > profile.mobileprovision
        
        # Extract UUID
        UUID=$(/usr/libexec/PlistBuddy -c 'Print UUID' /dev/stdin <<< $(security cms -D -i profile.mobileprovision 2>/dev/null) 2>/dev/null || true)
        
        if [ -z "$UUID" ]; then
          echo "âš ï¸ Using filename-based UUID"
          UUID="ios-profile-$(date +%s)"
        fi
        
        echo "Profile UUID: $UUID"
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp profile.mobileprovision \
          ~/Library/MobileDevice/Provisioning\ Profiles/"$UUID.mobileprovision"
        
        echo "âœ… Installed provisioning profile:"
        ls -la ~/Library/MobileDevice/Provisioning\ Profiles/

    # ===============================
    # BUILD IOS APP - PHÆ¯Æ NG PHÃP 1: Build thÃ´ng thÆ°á»ng
    # ===============================
    - name: Build iOS App (Method 1 - Standard)
      env:
        APPLE_TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        echo "Team ID: $APPLE_TEAM_ID"
        echo "Current directory: $(pwd)"
        
        # Clean
        rm -rf bin obj publish || true
        
        # Restore
        echo "Restoring packages..."
        dotnet restore
        
        # List projects
        echo "Available projects:"
        find . -name "*.csproj" -type f
        
        # Try to find the correct project file
        if [ -f "SixOSDatKhamAppMobile.csproj" ]; then
          PROJECT_FILE="SixOSDatKhamAppMobile.csproj"
        elif [ -f "SixOSDatKhamAppMobile/SixOSDatKhamAppMobile.csproj" ]; then
          PROJECT_FILE="SixOSDatKhamAppMobile/SixOSDatKhamAppMobile.csproj"
        else
          PROJECT_FILE=$(find . -name "*.csproj" -type f | head -1)
        fi
        
        echo "Using project file: $PROJECT_FILE"
        
        # Build for iOS - SIMPLE VERSION
        echo "Building iOS app..."
        dotnet build "$PROJECT_FILE" \
          -f net9.0-ios \
          -c Release \
          -p:RuntimeIdentifier=ios-arm64 \
          -p:Platform=iPhone \
          -p:ServerAddress=0.0.0.0 \
          -p:ServerPort=58181 \
          -p:DevelopmentTeam="$APPLE_TEAM_ID" \
          -p:ProvisioningType=automatic \
          -p:CodesignKey="Apple Development" \
          -p:CodesignEntitlements="" \
          --verbosity detailed
        
        echo "âœ… Build completed. Checking for .app bundle..."
        
        # TÃ¬m file .app
        find . -name "*.app" -type d 2>/dev/null | head -5
        
        # Kiá»ƒm tra thÆ° má»¥c bin
        echo "=== Checking bin directory ==="
        find ./bin -type f -name "*.dll" 2>/dev/null | head -5
        find ./bin -type d -name "*.app" 2>/dev/null

    # ===============================
    # CREATE IPA MANUALLY
    # ===============================
    - name: Create IPA manually if needed
      env:
        APPLE_TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        echo "Looking for .app bundle to create IPA..."
        
        # TÃ¬m .app bundle
        APP_PATH=$(find . -name "*.app" -type d 2>/dev/null | head -1)
        
        if [ -z "$APP_PATH" ]; then
          echo "âŒ No .app bundle found!"
          exit 1
        fi
        
        echo "Found .app bundle at: $APP_PATH"
        ls -la "$APP_PATH"
        
        # Táº¡o thÆ° má»¥c cho IPA
        mkdir -p Payload
        cp -R "$APP_PATH" Payload/
        
        # Táº¡o IPA
        IPA_NAME="SixOSDatKhamAppMobile.ipa"
        zip -qr "$IPA_NAME" Payload
        
        echo "âœ… IPA created: $IPA_NAME"
        ls -la "$IPA_NAME"
        
        # Di chuyá»ƒn Ä‘áº¿n thÆ° má»¥c publish
        mkdir -p publish
        mv "$IPA_NAME" publish/

    # ===============================
    # PHÆ¯Æ NG PHÃP 2: DÃ¹ng dotnet publish vá»›i cáº¥u hÃ¬nh Ä‘áº·c biá»‡t
    # ===============================
    - name: Try dotnet publish method
      if: failure()
      env:
        APPLE_TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        echo "Trying dotnet publish method..."
        
        # Clean
        rm -rf bin obj publish-ipa || true
        
        # XÃ¡c Ä‘á»‹nh project file
        if [ -f "SixOSDatKhamAppMobile.csproj" ]; then
          PROJECT_FILE="SixOSDatKhamAppMobile.csproj"
        else
          PROJECT_FILE=$(find . -name "*.csproj" -type f | head -1)
        fi
        
        echo "Using project: $PROJECT_FILE"
        
        # Publish vá»›i cáº¥u hÃ¬nh táº¡o IPA
        dotnet publish "$PROJECT_FILE" \
          -f net9.0-ios \
          -c Release \
          -p:RuntimeIdentifier=ios-arm64 \
          -p:Platform=iPhone \
          -p:BuildIpa=true \
          -p:IpaPackageDir="$(pwd)/publish-ipa" \
          -p:DevelopmentTeam="$APPLE_TEAM_ID" \
          -p:CodesignKey="Apple Development" \
          -p:CodesignEntitlements="" \
          -p:ProvisioningType=automatic \
          -p:ArchiveOnBuild=false \
          -o ./output \
          --verbosity diagnostic
        
        echo "Checking publish output..."
        find . -name "*.ipa" -type f 2>/dev/null
        
        # Náº¿u khÃ´ng tÃ¬m tháº¥y IPA, thá»­ tÃ¬m .app
        if [ ! -f "$(find . -name "*.ipa" -type f 2>/dev/null | head -1)" ]; then
          echo "No IPA found, looking for .app..."
          find . -name "*.app" -type d 2>/dev/null
        fi

    # ===============================
    # UPLOAD ARTIFACTS
    # ===============================
    - name: Upload Build Artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: iOS-Build-Output
        path: |
          ./bin/
          ./publish/
          ./publish-ipa/
          ./*.ipa
          ./*.app
        if-no-files-found: error
        retention-days: 7

    # ===============================
    # DEBUG INFO
    # ===============================
    - name: Collect Debug Information
      if: always()
      run: |
        echo "=== DEBUG INFORMATION ==="
        echo "Project structure:"
        find . -name "*.csproj" -o -name "*.sln" | head -10
        
        echo "Build output:"
        find ./bin -type f | head -20
        
        echo "Xcode version:"
        xcodebuild -version
        
        echo "Maui check:"
        dotnet workload list | grep maui || true
        
        echo "Available runtimes:"
        dotnet --list-runtimes

    - name: Cleanup keychain
      if: always()
      run: |
        echo "Cleaning up keychain..."
        security delete-keychain build.keychain 2>/dev/null || true
