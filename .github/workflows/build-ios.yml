name: Build iOS IPA with Code Signing

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-ipa:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET 9.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Install iOS workloads
      run: |
        sudo dotnet workload install maui-ios
        sudo dotnet workload install ios

    # ===============================
    # SETUP CODE SIGNING (OPTIONAL)
    # ===============================
    - name: Setup Code Signing (Optional)
      if: ${{ secrets.SIGNING_CERTIFICATE != '' }}
      env:
        SIGNING_CERTIFICATE: ${{ secrets.SIGNING_CERTIFICATE }}
        SIGNING_CERTIFICATE_PASSWORD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
        TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        echo "=== SETTING UP CODE SIGNING ==="
        
        # Táº¡o keychain
        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        
        # Import certificate náº¿u cÃ³
        if [ ! -z "$SIGNING_CERTIFICATE" ]; then
          echo "Importing certificate..."
          echo "$SIGNING_CERTIFICATE" | base64 --decode > certificate.p12
          security import certificate.p12 \
            -k build.keychain \
            -P "$SIGNING_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -A
          
          security set-key-partition-list \
            -S apple-tool:,apple:,codesign: \
            -s -k "" build.keychain
        fi
        
        # Import provisioning profile náº¿u cÃ³
        if [ ! -z "$PROVISIONING_PROFILE" ]; then
          echo "Importing provisioning profile..."
          echo "$PROVISIONING_PROFILE" | base64 --decode > profile.mobileprovision
          UUID=$(grep UUID -A1 -a profile.mobileprovision | grep -io "[-A-Z0-9]\{36\}")
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
        fi
        
        echo "âœ… Signing identities:"
        security find-identity -v -p codesigning build.keychain || true

    # ===============================
    # RESTORE AND BUILD
    # ===============================
    - name: Restore NuGet packages
      run: |
        echo "=== RESTORING PACKAGES ==="
        dotnet restore SixOSDatKhamAppMobile.csproj --verbosity normal

    - name: Build iOS App (Simulator - Test First)
      run: |
        echo "=== BUILDING FOR SIMULATOR (TEST) ==="
        
        # Clean
        dotnet clean SixOSDatKhamAppMobile.csproj -c Debug
        
        # Build cho simulator (khÃ´ng cáº§n signing)
        dotnet build SixOSDatKhamAppMobile.csproj \
          -f net9.0-ios \
          -c Debug \
          -p:RuntimeIdentifier=ios-x64 \
          -p:Platform=iPhoneSimulator \
          -p:BuildIpa=false \
          -p:CodesignKey="" \
          --verbosity normal
        
        echo "âœ… Simulator build completed"
        echo ""
        echo "Checking output structure:"
        find ./bin -name "*.app" -type d 2>/dev/null | head -5 || true

    # ===============================
    # BUILD IPA FOR DEVICE
    # ===============================
    - name: Build iOS IPA for Device
      env:
        TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        echo "=== BUILDING IPA FOR DEVICE ==="
        
        # Clean trÆ°á»›c
        rm -rf bin/Release/iphoneos obj publish ipa-output || true
        
        # XÃ¡c Ä‘á»‹nh build properties
        BUILD_PROPERTIES="-p:RuntimeIdentifier=ios-arm64"
        BUILD_PROPERTIES+=" -p:Platform=iPhone"
        BUILD_PROPERTIES+=" -p:BuildIpa=true"
        BUILD_PROPERTIES+=" -p:ArchiveOnBuild=true"
        BUILD_PROPERTIES+=" -p:Optimize=true"
        BUILD_PROPERTIES+=" -p:IpaPackageDir=$(pwd)/ipa-output"
        BUILD_PROPERTIES+=" -p:IpaPackageName=SixOSDatKhamAppMobile.ipa"
        
        # ThÃªm signing náº¿u cÃ³ Team ID
        if [ ! -z "$TEAM_ID" ]; then
          echo "Building with Team ID: $TEAM_ID"
          BUILD_PROPERTIES+=" -p:DevelopmentTeam=$TEAM_ID"
          BUILD_PROPERTIES+=" -p:CodesignKey=Apple Development"
          BUILD_PROPERTIES+=" -p:CodesignProvision=Automatic"
        else
          echo "âš ï¸ Building without code signing (ad-hoc)"
          BUILD_PROPERTIES+=" -p:CodesignKey="
          BUILD_PROPERTIES+=" -p:CodesignProvision="
          BUILD_PROPERTIES+=" -p:ProvisioningType=ad-hoc"
        fi
        
        # Thá»±c hiá»‡n publish
        echo "Publishing with properties:"
        echo "$BUILD_PROPERTIES"
        
        dotnet publish SixOSDatKhamAppMobile.csproj \
          -f net9.0-ios \
          -c Release \
          -o ./publish \
          $BUILD_PROPERTIES \
          --verbosity detailed
        
        echo "=== BUILD RESULTS ==="
        echo "1. Checking IPA files:"
        find . -name "*.ipa" -type f 2>/dev/null | xargs ls -la || echo "No IPA found"
        
        echo ""
        echo "2. Checking .app bundle:"
        find ./bin -name "*.app" -type d 2>/dev/null | head -3 | while read app; do
          echo "App: $app"
          du -sh "$app" || true
          echo "Contents:"
          find "$app" -type f | head -10
          echo "---"
        done

    # ===============================
    # FALLBACK BUILD OPTIONS
    # ===============================
    - name: Fallback Build (No Signing)
      if: failure()
      run: |
        echo "=== TRYING FALLBACK BUILD (NO SIGNING) ==="
        
        # Clean
        rm -rf bin/Release/iphoneos obj || true
        
        # Build khÃ´ng signing
        dotnet publish SixOSDatKhamAppMobile.csproj \
          -f net9.0-ios \
          -c Release \
          -p:RuntimeIdentifier=ios-arm64 \
          -p:Platform=iPhone \
          -p:BuildIpa=true \
          -p:ArchiveOnBuild=true \
          -p:Optimize=true \
          -p:CodesignKey="" \
          -p:CodesignProvision="" \
          -p:ProvisioningType=ad-hoc \
          -o ./publish-nosign \
          --verbosity normal
        
        # Kiá»ƒm tra káº¿t quáº£
        echo "Checking for IPA..."
        find ./publish-nosign -name "*.ipa" -type f 2>/dev/null | xargs -I {} cp {} ./SixOSDatKhamAppMobile-nosign.ipa
        
        if [ -f "./SixOSDatKhamAppMobile-nosign.ipa" ]; then
          echo "âœ… Fallback IPA created"
          ls -la *.ipa
          echo "IPA size: $(du -h SixOSDatKhamAppMobile-nosign.ipa | cut -f1)"
        fi

    # ===============================
    # VERIFY IPA CONTENTS
    # ===============================
    - name: Verify IPA
      if: success() || failure()
      run: |
        echo "=== VERIFYING IPA ==="
        
        # TÃ¬m táº¥t cáº£ IPA files
        IPA_FILES=$(find . -name "*.ipa" -type f 2>/dev/null)
        
        if [ -z "$IPA_FILES" ]; then
          echo "âŒ No IPA files found"
          echo ""
          echo "Checking what was built:"
          find ./bin -type f \( -name "*.dll" -o -name "*.app" \) | head -20
          exit 1
        fi
        
        for IPA in $IPA_FILES; do
          echo ""
          echo "ðŸ“¦ IPA: $IPA"
          echo "Size: $(du -h "$IPA" | cut -f1)"
          
          # Táº¡o temp Ä‘á»ƒ inspect
          TEMP_DIR=$(mktemp -d)
          unzip -q "$IPA" -d "$TEMP_DIR"
          
          # TÃ¬m .app bundle
          APP_BUNDLE=$(find "$TEMP_DIR" -name "*.app" -type d 2>/dev/null | head -1)
          
          if [ ! -z "$APP_BUNDLE" ]; then
            echo "App Bundle: $APP_BUNDLE"
            echo "App Size: $(du -sh "$APP_BUNDLE" | cut -f1)"
            echo "Contents:"
            find "$APP_BUNDLE" -type f | head -15
            
            # Check for key files
            echo ""
            echo "Essential files check:"
            [ -f "$APP_BUNDLE/Info.plist" ] && echo "âœ… Info.plist" || echo "âŒ Info.plist"
            [ -f "$APP_BUNDLE/_CodeSignature/CodeResources" ] && echo "âœ… CodeSignature" || echo "âš ï¸ No CodeSignature"
            
            # Check for .NET assemblies
            ASSEMBLIES=$(find "$APP_BUNDLE" -name "*.dll" -type f | wc -l)
            echo "âœ… .NET Assemblies: $ASSEMBLIES"
          else
            echo "âŒ No .app bundle found in IPA"
          fi
          
          rm -rf "$TEMP_DIR"
          echo "---"
        done

    # ===============================
    # UPLOAD ARTIFACTS
    # ===============================
    - name: Upload IPA Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: iOS-IPA-Build
        path: |
          *.ipa
          ./ipa-output/
          ./publish/
          ./publish-nosign/
        if-no-files-found: error
        retention-days: 30

    # ===============================
    # CLEANUP
    # ===============================
    - name: Cleanup
      if: always()
      run: |
        echo "Cleaning up..."
        security delete-keychain build.keychain 2>/dev/null || true
