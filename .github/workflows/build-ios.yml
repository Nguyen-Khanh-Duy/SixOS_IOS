name: Build iOS IPA

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-ipa:
    runs-on: macos-latest

    steps:
    # ===============================
    # CHECKOUT
    # ===============================
    - name: Checkout code
      uses: actions/checkout@v4

    # ===============================
    # SETUP .NET 9
    # ===============================
    - name: Setup .NET 9
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.200'

    - name: Verify .NET
      run: dotnet --info

    - name: Install MAUI iOS workload
      run: |
        dotnet workload install maui-ios --source https://api.nuget.org/v3/index.json
        dotnet workload install ios --source https://api.nuget.org/v3/index.json
        dotnet workload list

    # ===============================
    # SETUP CODE SIGNING
    # ===============================
    - name: Setup Code Signing
      env:
        SIGNING_CERTIFICATE: ${{ secrets.SIGNING_CERTIFICATE }}
        SIGNING_CERTIFICATE_PASSWORD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
      run: |
        echo "üîê Setting up signing..."

        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain

        echo "$SIGNING_CERTIFICATE" | base64 --decode > certificate.p12
        security import certificate.p12 \
          -k build.keychain \
          -P "$SIGNING_CERTIFICATE_PASSWORD" \
          -T /usr/bin/codesign \
          -A

        security set-key-partition-list \
          -S apple-tool:,apple:,codesign: \
          -s -k "" build.keychain
        security set-keychain-settings -t 3600 -l ~/Library/Keychains/build.keychain

        echo "$PROVISIONING_PROFILE" | base64 --decode > profile.mobileprovision
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

        echo "‚úÖ Available identities:"
        security find-identity -v -p codesigning

    # ===============================
    # BUILD IOS APP
    # ===============================
    - name: Build iOS App
      run: |
        echo "üöÄ Building iOS app..."
        
        # Clean
        dotnet clean SixOSDatKhamAppMobile.csproj -c Release || true
        
        # Restore
        dotnet restore SixOSDatKhamAppMobile.csproj
        
        # Build
        dotnet build SixOSDatKhamAppMobile.csproj \
            -f net9.0-ios \
            -c Release \
            -r ios-arm64 \
            --verbosity normal
        
        # Publish
        dotnet publish SixOSDatKhamAppMobile.csproj \
            -f net9.0-ios \
            -c Release \
            -r ios-arm64 \
            -p:ArchiveOnBuild=true \
            -p:BuildIpa=true \
            -p:CodesignKey="Apple Distribution" \
            -p:DevelopmentTeam="2DQG584W52" \
            -p:EnableCodeSigning=true \
            -o ./publish-output

    # ===============================
    # KI·ªÇM TRA FILE SAU BUILD
    # ===============================
    - name: Check Build Output
      run: |
        echo "üìÅ Ki·ªÉm tra files sau build..."
        echo "1. T√¨m t·∫•t c·∫£ .dll files:"
        find . -name "*.dll" -type f | head -20 || echo "No DLL files found"
        
        echo "\n2. T√¨m file SixOSDatKhamAppMobile.dll c·ª• th·ªÉ:"
        find . -name "SixOSDatKhamAppMobile.dll" -type f || echo "Not found"

    # ===============================
    # T·∫†O IPA T·ª™ DLL (ƒê√É FIX L·ªñI)
    # ===============================
    - name: Create IPA from DLL files
      run: |
        echo "üì¶ T·∫°o IPA t·ª´ DLL files..."
        
        # T·∫°o c·∫•u tr√∫c th∆∞ m·ª•c
        mkdir -p app/Payload
        
        # T√¨m file ch√≠nh
        echo "T√¨m ki·∫øm SixOSDatKhamAppMobile.dll..."
        MAIN_DLL=$(find . -name "SixOSDatKhamAppMobile.dll" -type f | head -1)
        
        if [ -n "$MAIN_DLL" ]; then
          echo "‚úÖ Found main DLL at: $MAIN_DLL"
          
          # T·∫°o app bundle structure
          APP_NAME="SixOSDatKhamAppMobile.app"
          mkdir -p "app/Payload/$APP_NAME"
          
          # Copy t·∫•t c·∫£ files t·ª´ th∆∞ m·ª•c ch·ª©a DLL
          DLL_DIR=$(dirname "$MAIN_DLL")
          echo "Copying files from: $DLL_DIR"
          cp -r "$DLL_DIR"/* "app/Payload/$APP_NAME/" 2>/dev/null || true
          
          # Copy th√™m c√°c DLL kh√°c (dependencies)
          echo "Copying additional DLLs..."
          find . -name "*.dll" -type f -exec cp {} "app/Payload/$APP_NAME/" 2>/dev/null \;
          
          # T·∫°o file Info.plist (d√πng echo thay v√¨ heredoc)
          echo "T·∫°o file Info.plist..."
          echo '<?xml version="1.0" encoding="UTF-8"?>' > "app/Payload/$APP_NAME/Info.plist"
          echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> "app/Payload/$APP_NAME/Info.plist"
          echo '<plist version="1.0">' >> "app/Payload/$APP_NAME/Info.plist"
          echo '<dict>' >> "app/Payload/$APP_NAME/Info.plist"
          echo '    <key>CFBundleName</key>' >> "app/Payload/$APP_NAME/Info.plist"
          echo '    <string>SixOSDatKhamAppMobile</string>' >> "app/Payload/$APP_NAME/Info.plist"
          echo '    <key>CFBundleIdentifier</key>' >> "app/Payload/$APP_NAME/Info.plist"
          echo '    <string>com.yourcompany.SixOSDatKhamAppMobile</string>' >> "app/Payload/$APP_NAME/Info.plist"
          echo '    <key>CFBundleVersion</key>' >> "app/Payload/$APP_NAME/Info.plist"
          echo '    <string>1.0</string>' >> "app/Payload/$APP_NAME/Info.plist"
          echo '    <key>CFBundleExecutable</key>' >> "app/Payload/$APP_NAME/Info.plist"
          echo '    <string>SixOSDatKhamAppMobile</string>' >> "app/Payload/$APP_NAME/Info.plist"
          echo '    <key>CFBundlePackageType</key>' >> "app/Payload/$APP_NAME/Info.plist"
          echo '    <string>APPL</string>' >> "app/Payload/$APP_NAME/Info.plist"
          echo '</dict>' >> "app/Payload/$APP_NAME/Info.plist"
          echo '</plist>' >> "app/Payload/$APP_NAME/Info.plist"
          
          # T·∫°o file executable (c·∫ßn thi·∫øt cho iOS)
          touch "app/Payload/$APP_NAME/SixOSDatKhamAppMobile"
          chmod +x "app/Payload/$APP_NAME/SixOSDatKhamAppMobile"
          
          # T·∫°o IPA
          echo "T·∫°o file IPA..."
          cd app
          zip -r ../SixOSDatKhamAppMobile.ipa Payload/
          cd ..
          
          # Ki·ªÉm tra v√† copy IPA
          if [ -f "SixOSDatKhamAppMobile.ipa" ]; then
            echo "‚úÖ Successfully created IPA"
            mkdir -p ipa-output
            cp SixOSDatKhamAppMobile.ipa ipa-output/
            ls -la ipa-output/
          else
            echo "‚ùå Failed to create IPA"
          fi
        else
          echo "‚ùå Kh√¥ng t√¨m th·∫•y main DLL"
          
          # Li·ªát k√™ t·∫•t c·∫£ DLL files ƒë·ªÉ debug
          echo "T·∫•t c·∫£ DLL files found:"
          find . -name "*.dll" -type f | head -20
        fi

    # ===============================
    # C√ÅCH 2: T·∫†O IPA T·ª™ TH∆Ø M·ª§C BIN
    # ===============================
    - name: Alternative - Create IPA from bin directory
      if: failure()
      run: |
        echo "üì¶ Th·ª≠ t·∫°o IPA t·ª´ th∆∞ m·ª•c bin..."
        
        # T√¨m th∆∞ m·ª•c Release ch·ª©a nhi·ªÅu DLL nh·∫•t
        RELEASE_DIR=$(find . -type d -path "*/bin/Release/*" | head -1)
        
        if [ -n "$RELEASE_DIR" ]; then
          echo "Found release directory: $RELEASE_DIR"
          
          # T·∫°o c·∫•u tr√∫c Payload
          mkdir -p Payload/App.app
          
          # Copy all files
          cp -r "$RELEASE_DIR"/* Payload/App.app/ 2>/dev/null || true
          
          # T·∫°o IPA
          zip -r app.ipa Payload/
          
          if [ -f "app.ipa" ]; then
            echo "‚úÖ Created IPA"
            mkdir -p ipa-output
            cp app.ipa ipa-output/
          fi
        fi

    # ===============================
    # UPLOAD ARTIFACTS
    # ===============================
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: iOS-Build-${{ github.sha }}
        path: |
          ipa-output/
          **/*.dll
          publish-output/
        retention-days: 7
        if-no-files-found: warn

    # ===============================
    # CLEANUP
    # ===============================
    - name: Cleanup
      if: always()
      run: |
        security delete-keychain build.keychain || true
        rm -f certificate.p12 profile.mobileprovision
