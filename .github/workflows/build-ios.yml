name: Build iOS IPA

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-ipa:
    runs-on: macos-latest

    steps:
    # ===============================
    # CHECKOUT
    # ===============================
    - name: Checkout code
      uses: actions/checkout@v4

    # ===============================
    # SETUP .NET 9
    # ===============================
    - name: Setup .NET 9
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.200'

    - name: Verify .NET
      run: dotnet --info

    - name: Install MAUI iOS workload
      run: |
        dotnet workload install maui-ios --source https://api.nuget.org/v3/index.json
        dotnet workload install ios --source https://api.nuget.org/v3/index.json
        dotnet workload list

    # ===============================
    # SETUP CODE SIGNING
    # ===============================
    - name: Setup Code Signing
      env:
        SIGNING_CERTIFICATE: ${{ secrets.SIGNING_CERTIFICATE }}
        SIGNING_CERTIFICATE_PASSWORD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
      run: |
        echo "ðŸ” Setting up signing..."

        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain

        echo "$SIGNING_CERTIFICATE" | base64 --decode > certificate.p12
        security import certificate.p12 \
          -k build.keychain \
          -P "$SIGNING_CERTIFICATE_PASSWORD" \
          -T /usr/bin/codesign \
          -A

        security set-key-partition-list \
          -S apple-tool:,apple:,codesign: \
          -s -k "" build.keychain
        security set-keychain-settings -t 3600 -l ~/Library/Keychains/build.keychain

        echo "$PROVISIONING_PROFILE" | base64 --decode > profile.mobileprovision
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

        echo "âœ… Available identities:"
        security find-identity -v -p codesigning

    # ===============================
    # BUILD IPA WITH DOTNET PUBLISH
    # ===============================
    - name: Build iOS App
      run: |
        echo "ðŸš€ Building iOS app..."
        
        # Clean
        dotnet clean SixOSDatKhamAppMobile.csproj -c Release
        
        # Restore
        dotnet restore SixOSDatKhamAppMobile.csproj
        
        # Build trÆ°á»›c
        dotnet build SixOSDatKhamAppMobile.csproj \
            -f net9.0-ios \
            -c Release \
            -r ios-arm64 \
            --verbosity normal
        
        # Publish vá»›i cáº¥u hÃ¬nh chi tiáº¿t
        dotnet publish SixOSDatKhamAppMobile.csproj \
            -f net9.0-ios \
            -c Release \
            -r ios-arm64 \
            -p:ArchiveOnBuild=true \
            -p:BuildIpa=true \
            -p:CodesignKey="Apple Distribution" \
            -p:DevelopmentTeam="2DQG584W52" \
            -p:RuntimeIdentifier=ios-arm64 \
            -p:CreatePackage=false \
            -p:EnableCodeSigning=true \
            -o ./publish-output \
            --verbosity diag > build.log 2>&1
        
        echo "âœ… Build completed"

    # ===============================
    # KIá»‚M TRA Káº¾T QUáº¢ BUILD
    # ===============================
    - name: Check Build Output
      if: always()
      run: |
        echo "ðŸ“ Kiá»ƒm tra thÆ° má»¥c build..."
        
        # Kiá»ƒm tra cÃ¡c thÆ° má»¥c
        echo "1. Current directory:"
        pwd
        
        echo "\n2. Contents of current directory:"
        ls -la
        
        echo "\n3. Checking bin directory:"
        find ./bin -type d 2>/dev/null | head -20 || echo "No bin directory"
        
        echo "\n4. Checking obj directory:"
        find ./obj -type d 2>/dev/null | head -20 || echo "No obj directory"
        
        echo "\n5. Checking publish-output directory:"
        ls -la ./publish-output/ 2>/dev/null || echo "No publish-output directory"
        
        echo "\n6. Searching for any .app files:"
        find . -name "*.app" -type d 2>/dev/null || echo "No .app files found"
        
        echo "\n7. Searching for any .ipa files:"
        find . -name "*.ipa" -type f 2>/dev/null || echo "No .ipa files found"
        
        echo "\n8. Searching for executable files:"
        find . -name "*.exe" -o -name "*.dll" 2>/dev/null | head -20

    # ===============================
    # Táº O IPA Tá»ª FILE DLL (CACH 1)
    # ===============================
    - name: Create IPA from DLL files
      run: |
        echo "ðŸ“¦ Táº¡o IPA tá»« DLL files..."
        
        # Táº¡o cáº¥u trÃºc thÆ° má»¥c
        mkdir -p app/Payload
        
        # TÃ¬m file chÃ­nh
        MAIN_DLL=$(find . -name "SixOSDatKhamAppMobile.dll" -type f | head -1)
        
        if [ -n "$MAIN_DLL" ]; then
          echo "âœ… Found main DLL at: $MAIN_DLL"
          
          # Táº¡o app bundle structure
          APP_NAME="SixOSDatKhamAppMobile.app"
          mkdir -p "app/Payload/$APP_NAME"
          
          # Copy táº¥t cáº£ files tá»« thÆ° má»¥c chá»©a DLL
          DLL_DIR=$(dirname "$MAIN_DLL")
          echo "Copying files from: $DLL_DIR"
          cp -r "$DLL_DIR"/* "app/Payload/$APP_NAME/" 2>/dev/null || true
          
          # Táº¡o Info.plist cÆ¡ báº£n
          cat > "app/Payload/$APP_NAME/Info.plist" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleName</key>
              <string>SixOSDatKhamAppMobile</string>
              <key>CFBundleIdentifier</key>
              <string>com.yourcompany.SixOSDatKhamAppMobile</string>
              <key>CFBundleVersion</key>
              <string>1.0</string>
              <key>CFBundleExecutable</key>
              <string>SixOSDatKhamAppMobile</string>
          </dict>
          </plist>
          EOF
          
          # Táº¡o IPA
          cd app
          zip -r ../SixOSDatKhamAppMobile.ipa Payload/
          cd ..
          
          if [ -f "SixOSDatKhamAppMobile.ipa" ]; then
            echo "âœ… Successfully created IPA"
            mkdir -p ipa-output
            cp SixOSDatKhamAppMobile.ipa ipa-output/
          fi
        else
          echo "âŒ KhÃ´ng tÃ¬m tháº¥y main DLL"
        fi

    # ===============================
    # Táº O IPA Tá»ª THÆ¯ Má»¤C PUBLISH (CACH 2)
    # ===============================
    - name: Create IPA from publish directory
      if: failure()  # Cháº¡y náº¿u cÃ¡ch 1 tháº¥t báº¡i
      run: |
        echo "ðŸ“¦ Thá»­ táº¡o IPA tá»« thÆ° má»¥c publish..."
        
        # TÃ¬m thÆ° má»¥c publish
        PUBLISH_DIRS=$(find . -type d -name "publish" 2>/dev/null)
        
        for dir in $PUBLISH_DIRS; do
          echo "Checking: $dir"
          
          if [ -d "$dir" ]; then
            # Táº¡o cáº¥u trÃºc Payload
            mkdir -p Payload
            
            # Copy toÃ n bá»™ ná»™i dung
            cp -r "$dir"/* Payload/ 2>/dev/null || true
            
            # TÃ¬m vÃ  Ä‘áº·t tÃªn app
            APP_NAME="App.app"
            mv Payload Payload_temp
            mkdir -p "Payload/$APP_NAME"
            cp -r Payload_temp/* "Payload/$APP_NAME/" 2>/dev/null || true
            rm -rf Payload_temp
            
            # Táº¡o IPA
            zip -r "app.ipa" Payload/
            
            if [ -f "app.ipa" ]; then
              echo "âœ… Created IPA from $dir"
              mkdir -p ipa-output
              cp app.ipa ipa-output/
              break
            fi
          fi
        done

    # ===============================
    # UPLOAD Táº¤T Cáº¢ ARTIFACTS
    # ===============================
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: iOS-Build-${{ github.sha }}
        path: |
          ipa-output/
          **/*.dll
          **/*.exe
          **/*.pdb
          build.log
          publish-output/
          bin/
        retention-days: 7
        if-no-files-found: warn

    # ===============================
    # DEBUG INFO
    # ===============================
    - name: Debug Info
      if: always()
      run: |
        echo "ðŸ“‚ Full directory structure:"
        find . -type f -name "*.dll" -o -name "*.ipa" -o -name "*.app" | head -30
        
        echo "\nðŸ“„ Build log (last 50 lines):"
        if [ -f build.log ]; then
          tail -50 build.log
        fi

    # ===============================
    # CLEANUP
    # ===============================
    - name: Cleanup
      if: always()
      run: |
        security delete-keychain build.keychain || true
        rm -f certificate.p12 profile.mobileprovision
