name: Build iOS IPA

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-ipa:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ===============================
    # SETUP .NET 9.0 SPECIFIC
    # ===============================
    - name: Setup .NET 9.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.310'  # D√πng phi√™n b·∫£n c·ª• th·ªÉ

    - name: Install MAUI Workloads
      run: |
        echo "=== INSTALLING MAUI WORKLOADS ==="
        # X√≥a workload c≈© n·∫øu c√≥
        sudo dotnet workload uninstall maui --verbosity normal || true
        sudo dotnet workload uninstall ios --verbosity normal || true
        
        # C√†i workload cho .NET 9
        sudo dotnet workload install maui --sdk-version 9.0.310
        sudo dotnet workload install ios --sdk-version 9.0.310
        
        echo "‚úÖ Workloads installed"
        dotnet workload list

    - name: Force Use .NET 9
      run: |
        # T·∫°o global.json ƒë·ªÉ b·∫Øt bu·ªôc d√πng .NET 9
        cat > global.json << EOF
        {
          "sdk": {
            "version": "9.0.310",
            "rollForward": "disable"
          }
        }
        EOF
        
        echo "Using .NET SDK:"
        dotnet --version

    # ===============================
    # CHECK PROJECT
    # ===============================
    - name: Check Project Configuration
      run: |
        echo "=== CHECKING PROJECT ==="
        
        # S·ª≠a csproj n·∫øu c·∫ßn
        if grep -q "net9.0-ios" SixOSDatKhamAppMobile.csproj; then
          echo "‚úÖ Project targets net9.0-ios"
        else
          echo "‚ùå Project does not target net9.0-ios"
          exit 1
        fi
        
        echo ""
        echo "Project structure:"
        ls -la

    # ===============================
    # RESTORE PACKAGES
    # ===============================
    - name: Restore Packages
      run: |
        echo "=== RESTORING PACKAGES ==="
        
        # X√≥a obj v√† bin c≈©
        rm -rf obj/ bin/
        
        # Restore v·ªõi framework c·ª• th·ªÉ
        dotnet restore SixOSDatKhamAppMobile.csproj \
          --runtime ios-arm64 \
          --verbosity detailed
        
        echo "‚úÖ Restore completed"

    # ===============================
    # BUILD FOR SIMULATOR
    # ===============================
    - name: Build for Simulator
      run: |
        echo "=== BUILDING FOR SIMULATOR ==="
        
        dotnet build SixOSDatKhamAppMobile.csproj \
          -f net9.0-ios \
          -c Debug \
          -p:RuntimeIdentifier=ios-x64 \
          -p:Platform=iPhoneSimulator \
          -p:BuildIpa=false \
          --verbosity normal
        
        echo "‚úÖ Simulator build successful"
        
        # Ki·ªÉm tra
        echo "Simulator output:"
        find ./bin -name "*.dll" | head -5

    # ===============================
    # BUILD FOR DEVICE (SIMPLE)
    # ===============================
    - name: Build for Device
      run: |
        echo "=== BUILDING FOR DEVICE ==="
        
        # Clean
        rm -rf bin/Release/ net9.0-ios/ publish/ ipa-output/ || true
        
        # Build ƒë∆°n gi·∫£n - kh√¥ng code signing
        dotnet publish SixOSDatKhamAppMobile.csproj \
          -f net9.0-ios \
          -c Release \
          -p:RuntimeIdentifier=ios-arm64 \
          -p:Platform=iPhone \
          -p:BuildIpa=true \
          -p:ArchiveOnBuild=true \
          -p:CreatePackage=true \
          -p:EnableCodeSigning=false \
          -p:IpaPackageDir="$(pwd)/ipa-output" \
          -o ./publish \
          --verbosity detailed
        
        echo "=== BUILD COMPLETED ==="

    # ===============================
    # CHECK RESULTS
    # ===============================
    - name: Check Build Results
      run: |
        echo "=== BUILD RESULTS ==="
        
        echo "1. Current directory:"
        ls -la
        
        echo ""
        echo "2. IPA files:"
        find . -name "*.ipa" -type f 2>/dev/null | while read ipa; do
          echo "üì¶ $ipa"
          echo "   Size: $(du -h "$ipa" | cut -f1)"
        done || echo "No IPA files"
        
        echo ""
        echo "3. App bundles:"
        find . -name "*.app" -type d 2>/dev/null | while read app; do
          echo "üì± $app"
          echo "   Size: $(du -sh "$app" | cut -f1)"
        done || echo "No app bundles"
        
        echo ""
        echo "4. Publish directory:"
        ls -la ./publish/ 2>/dev/null || true
        
        echo ""
        echo "5. IPA output directory:"
        ls -la ./ipa-output/ 2>/dev/null || true

    # ===============================
    # CREATE FALLBACK IPA
    # ===============================
    - name: Create Fallback IPA
      if: failure()
      run: |
        echo "=== CREATING FALLBACK IPA ==="
        
        # T√¨m app bundle
        APP_BUNDLE=$(find ./bin -name "*.app" -type d 2>/dev/null | head -1)
        
        if [ ! -z "$APP_BUNDLE" ]; then
          echo "Found: $APP_BUNDLE"
          
          # T·∫°o IPA th·ªß c√¥ng
          mkdir -p temp-ipa/Payload
          cp -R "$APP_BUNDLE" temp-ipa/Payload/
          cd temp-ipa
          zip -qr "../SixOS_Fallback.ipa" .
          cd ..
          
          echo "‚úÖ Created fallback IPA"
          ls -la *.ipa
        else
          echo "‚ö†Ô∏è Could not find app bundle"
          
          # Ki·ªÉm tra build output
          echo "Build output in bin:"
          find ./bin -type f | head -20
        fi

    # ===============================
    # UPLOAD ARTIFACTS
    # ===============================
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: iOS-Build
        path: |
          *.ipa
          ./ipa-output/
          ./publish/
          ./bin/
        if-no-files-found: warn
        retention-days: 30

    # ===============================
    # DEBUG
    # ===============================
    - name: Debug Info
      if: always()
      run: |
        echo "=== DEBUG INFO ==="
        echo "Dotnet version: $(dotnet --version)"
        echo ""
        echo "Project file head:"
        head -30 SixOSDatKhamAppMobile.csproj
        echo ""
        echo "All files:"
        find . -type f -name "*.csproj" -o -name "*.sln" | xargs -I {} echo "Found: {}"
