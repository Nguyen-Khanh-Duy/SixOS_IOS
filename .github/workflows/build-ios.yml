name: Build iOS/Mac Catalyst IPA (.NET 9 MAUI)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout mã nguồn
      uses: actions/checkout@v4

    - name: Cài đặt .NET 9 SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Hiển thị thông tin hệ thống
      run: |
        echo "=== Thông tin hệ thống ==="
        uname -a
        sw_vers
        echo "=== Thông tin .NET ==="
        dotnet --info

    - name: Cài đặt workloads MAUI cho .NET 9
      run: |
        echo "=== Cài đặt workloads cần thiết ==="
        
        # Cài đặt MAUI workload (bao gồm iOS/Mac Catalyst)
        echo "1. Cài đặt MAUI workload..."
        dotnet workload install maui
        
        echo "=== Danh sách workloads đã cài đặt ==="
        dotnet workload list

    - name: Khôi phục dependencies với ignore errors
      run: |
        echo "=== Đang restore dependencies với NoWarn ==="
        dotnet restore --verbosity normal /p:NoWarn=NETSDK1202

    - name: Build cho Mac Catalyst (.NET 9)
      run: |
        echo "=== Building cho Mac Catalyst (.NET 9) ==="
        
        # Build với Mac Catalyst
        dotnet publish SixOSDatKhamAppMobile.csproj \
          -f net9.0-maccatalyst \
          -c Release \
          -p:BuildIpa=true \
          -p:ArchiveOnBuild=true \
          -p:EnableCodeSigning=false \
          -p:EnablePackageSigning=false \
          -p:MtouchLink=SdkOnly \
          -p:CreatePackage=true \
          -p:NoWarn=NETSDK1202 \
          --verbosity normal
        
        echo "=== Đã build xong ==="

    - name: Tìm và liệt kê file output
      run: |
        echo "=== Tìm file .ipa ==="
        find . -name "*.ipa" -type f 2>/dev/null || echo "Không tìm thấy file .ipa"
        
        echo "=== Tìm file .app ==="
        find . -name "*.app" -type d 2>/dev/null || echo "Không tìm thấy file .app"
        
        echo "=== Cấu trúc thư mục bin ==="
        find . -path "./bin/Release/*" -type d 2>/dev/null | head -20 || true

    - name: Upload file IPA
      uses: actions/upload-artifact@v4
      with:
        name: mac-catalyst-ipa
        path: |
          **/bin/Release/net9.0-maccatalyst/**/*.ipa
          **/bin/Release/**/*.ipa
        if-no-files-found: warn
