name: Fix iOS App Bundle Build

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Install MAUI
      run: |
        dotnet workload install maui
        dotnet workload install maui-ios
        dotnet workload install ios

    - name: Analyze Project
      run: |
        echo "=== PROJECT ANALYSIS ==="
        echo "1. Looking for .csproj files:"
        find . -name "*.csproj" -type f
        
        echo ""
        echo "2. Project content:"
        if [ -f "SixOSDatKhamAppMobile.csproj" ]; then
          cat SixOSDatKhamAppMobile.csproj
        else
          PROJ=$(find . -name "*.csproj" -type f | head -1)
          echo "First .csproj found: $PROJ"
          cat "$PROJ"
        fi

    - name: Build for iOS Simulator (Test)
      run: |
        echo "=== TEST BUILD FOR SIMULATOR ==="
        
        # Clean
        rm -rf bin obj || true
        
        # Tìm project
        if [ -f "SixOSDatKhamAppMobile.csproj" ]; then
          PROJ="SixOSDatKhamAppMobile.csproj"
        else
          PROJ=$(find . -name "*.csproj" -type f | head -1)
        fi
        
        echo "Building: $PROJ"
        
        # Build for simulator
        dotnet build "$PROJ" \
          -f net9.0-ios \
          -c Debug \
          -p:RuntimeIdentifier=ios-x64 \
          -p:Platform=iPhoneSimulator \
          --verbosity detailed
        
        echo "=== CHECKING FOR .APP ==="
        find . -name "*.app" -type d 2>/dev/null || echo "No .app found"

    - name: Build for Device
      if: success() || failure()
      env:
        TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        echo "=== BUILDING FOR iOS DEVICE ==="
        
        # Tìm project
        if [ -f "SixOSDatKhamAppMobile.csproj" ]; then
          PROJ="SixOSDatKhamAppMobile.csproj"
        else
          PROJ=$(find . -name "*.csproj" -type f | head -1)
        fi
        
        echo "Team ID: ${TEAM_ID:-NOT SET}"
        echo "Project: $PROJ"
        
        # Clean
        rm -rf bin obj publish || true
        
        # Build cho device
        echo "Running build command..."
        dotnet publish "$PROJ" \
          -f net9.0-ios \
          -c Release \
          -p:RuntimeIdentifier=ios-arm64 \
          -p:Platform=iPhone \
          -p:BuildIpa=true \
          -p:ArchiveOnBuild=true \
          -p:CreatePackage=true \
          -p:IpaPackageDir="$(pwd)/ipa" \
          -p:DevelopmentTeam="$TEAM_ID" \
          -p:CodesignKey="Apple Development" \
          -p:ServerAddress=0.0.0.0 \
          -p:ServerPort=58181 \
          -p:TreatWarningsAsErrors=false \
          -o ./publish \
          --verbosity diagnostic
        
        echo "=== SEARCHING FOR OUTPUT ==="
        echo "1. All .ipa files:"
        find . -name "*.ipa" -type f 2>/dev/null
        
        echo ""
        echo "2. All .app bundles:"
        find . -name "*.app" -type d 2>/dev/null
        
        echo ""
        echo "3. Publish directory:"
        ls -la ./publish/ 2>/dev/null || echo "No publish directory"
        
        echo ""
        echo "4. IPA directory:"
        ls -la ./ipa/ 2>/dev/null || echo "No ipa directory"
        
        echo ""
        echo "5. Bin directory structure:"
        find ./bin -type f -name "*.dll" | head -10

    - name: Create Minimal .app Bundle
      if: always()
      run: |
        echo "=== CREATING MINIMAL .APP BUNDLE ==="
        
        # Tạo cấu trúc .app đơn giản
        APP_DIR="SixOSDatKhamAppMobile.app"
        mkdir -p "$APP_DIR"
        mkdir -p "$APP_DIR/Contents"
        mkdir -p "$APP_DIR/Contents/MacOS"
        mkdir -p "$APP_DIR/Contents/Resources"
        
        # Tạo Info.plist
        cat > "$APP_DIR/Contents/Info.plist" << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
        <key>CFBundleDisplayName</key>
        <string>SixOSDatKhamAppMobile</string>
        <key>CFBundleExecutable</key>
        <string>SixOSDatKhamAppMobile</string>
        <key>CFBundleIdentifier</key>
        <string>com.company.SixOSDatKhamAppMobile</string>
        <key>CFBundleName</key>
        <string>SixOSDatKhamAppMobile</string>
        <key>CFBundleVersion</key>
        <string>1.0</string>
        <key>CFBundleShortVersionString</key>
        <string>1.0</string>
        <key>CFBundlePackageType</key>
        <string>APPL</string>
        <key>LSRequiresIPhoneOS</key>
        <true/>
        <key>MinimumOSVersion</key>
        <string>14.0</string>
        </dict>
        </plist>
        EOF
        
        # Tạo executable
        cat > "$APP_DIR/Contents/MacOS/SixOSDatKhamAppMobile" << 'EOF'
          #!/bin/bash
          echo "iOS App Bundle - Placeholder"
          exit 0
          EOF
        chmod +x "$APP_DIR/Contents/MacOS/SixOSDatKhamAppMobile"
        
        # Tạo IPA từ .app
        mkdir -p Payload
        cp -R "$APP_DIR" Payload/
        zip -qr "SixOSDatKhamAppMobile.ipa" Payload/
        
        echo "✅ Created minimal .app and IPA"
        ls -la "SixOSDatKhamAppMobile.ipa"
        du -sh "SixOSDatKhamAppMobile.app"

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: iOS-Build-Results
        path: |
          ./bin/
          ./publish/
          ./ipa/
          ./*.ipa
          ./*.app
        if-no-files-found: warn
        retention-days: 7
