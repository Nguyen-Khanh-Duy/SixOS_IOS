name: Build iOS IPA (.NET 9)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-ipa:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ===============================
    # SETUP .NET 9 WITH GLOBAL.JSON FIRST
    # ===============================
    - name: Create global.json for .NET 9
      run: |
        echo "=== SETTING .NET 9 AS DEFAULT ==="
        cat > global.json << 'EOF'
        {
          "sdk": {
            "version": "9.0.310",
            "rollForward": "disable",
            "allowPrerelease": false
          }
        }
        EOF
        
        echo "global.json created:"
        cat global.json

    - name: Setup .NET 9
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.310'

    - name: Verify .NET Version
      run: |
        echo "Active .NET SDK:"
        dotnet --version
        echo ""
        echo "SDK location:"
        which dotnet
        echo ""
        echo "All .NET SDKs:"
        ls -la /Users/runner/.dotnet/sdk/

    # ===============================
    # INSTALL MAUI WORKLOADS
    # ===============================
    - name: Install MAUI Workloads
      run: |
        echo "=== INSTALLING MAUI WORKLOADS ==="
        
        # Kiá»ƒm tra workloads hiá»‡n táº¡i
        echo "Current workloads:"
        dotnet workload list || true
        
        # CÃ i workload maui vÃ  ios
        echo "Installing maui workload..."
        sudo dotnet workload install maui
        
        echo "Installing ios workload..."
        sudo dotnet workload install ios
        
        echo "âœ… Workloads installed"
        dotnet workload list

    # ===============================
    # CHECK PROJECT
    # ===============================
    - name: Check Project Configuration
      run: |
        echo "=== CHECKING PROJECT ==="
        
        # Kiá»ƒm tra target framework
        if grep -q "net9.0-ios" SixOSDatKhamAppMobile.csproj; then
          echo "âœ… Project targets net9.0-ios"
        else
          echo "âŒ Project does not target net9.0-ios"
          echo "Project content:"
          cat SixOSDatKhamAppMobile.csproj
          exit 1
        fi
        
        echo ""
        echo "Project structure:"
        ls -la

    # ===============================
    # RESTORE PACKAGES
    # ===============================
    - name: Restore Packages
      run: |
        echo "=== RESTORING PACKAGES ==="
        
        # XÃ³a obj vÃ  bin cÅ©
        rm -rf obj/ bin/ || true
        
        # Restore Ä‘Æ¡n giáº£n
        dotnet restore SixOSDatKhamAppMobile.csproj
        
        echo "âœ… Restore completed"
        echo ""
        echo "Restore output:"
        ls -la obj/ 2>/dev/null || echo "No obj directory"

    # ===============================
    # BUILD FOR SIMULATOR (TEST)
    # ===============================
    - name: Build for Simulator
      run: |
        echo "=== BUILDING FOR SIMULATOR ==="
        
        # Build simulator (khÃ´ng cáº§n code signing)
        dotnet build SixOSDatKhamAppMobile.csproj \
          -f net9.0-ios \
          -c Debug \
          -p:RuntimeIdentifier=ios-x64 \
          -p:Platform=iPhoneSimulator \
          -p:BuildIpa=false \
          --verbosity minimal
        
        echo "âœ… Simulator build successful"
        
        # Kiá»ƒm tra output
        echo "Build output:"
        find ./bin -type f -name "*.dll" | head -5 || true

    # ===============================
    # BUILD FOR DEVICE
    # ===============================
    - name: Build for Device
      run: |
        echo "=== BUILDING FOR DEVICE ==="
        
        # Clean
        rm -rf bin/Release/ net9.0-ios/ publish/ ipa-output/ || true
        
        echo "Building with properties..."
        
        # Build cho device - Ä‘Æ¡n giáº£n hÃ³a
        dotnet publish SixOSDatKhamAppMobile.csproj \
          -f net9.0-ios \
          -c Release \
          -p:RuntimeIdentifier=ios-arm64 \
          -p:Platform=iPhone \
          -p:BuildIpa=true \
          -p:ArchiveOnBuild=true \
          -p:CreatePackage=true \
          -o ./publish \
          --verbosity normal
        
        echo "=== BUILD COMPLETED ==="

    # ===============================
    # CHECK RESULTS
    # ===============================
    - name: Check Build Results
      run: |
        echo "=== BUILD RESULTS ==="
        
        echo "1. Current directory:"
        ls -la
        
        echo ""
        echo "2. All IPA files:"
        find . -name "*.ipa" -type f 2>/dev/null | while read ipa; do
          echo "ðŸ“¦ IPA: $ipa"
          echo "   Size: $(du -h "$ipa" | cut -f1)"
        done || echo "No IPA files found"
        
        echo ""
        echo "3. All App bundles:"
        find . -name "*.app" -type d 2>/dev/null | while read app; do
          echo "ðŸ“± App: $app"
          echo "   Size: $(du -sh "$app" | cut -f1)"
          echo "   Contents:"
          find "$app" -type f | head -5
          echo ""
        done || echo "No app bundles found"
        
        echo ""
        echo "4. Bin directory structure:"
        find ./bin -type d 2>/dev/null || echo "No bin directory"
        
        echo ""
        echo "5. Publish directory:"
        ls -la ./publish/ 2>/dev/null || echo "No publish directory"

    # ===============================
    # ALTERNATIVE: SIMPLE BUILD
    # ===============================
    - name: Simple Build (Fallback)
      if: failure()
      run: |
        echo "=== SIMPLE BUILD FALLBACK ==="
        
        # Build cá»±c Ä‘Æ¡n giáº£n
        dotnet build SixOSDatKhamAppMobile.csproj \
          -f net9.0-ios \
          -c Release \
          -p:RuntimeIdentifier=ios-arm64 \
          --verbosity minimal
        
        echo "âœ… Simple build completed"
        
        # Kiá»ƒm tra app bundle
        echo "Looking for app bundle..."
        find ./bin -name "*.app" -type d | while read app; do
          echo "Found: $app"
          du -sh "$app"
          
          # Táº¡o IPA thá»§ cÃ´ng
          mkdir -p temp-ipa/Payload
          cp -R "$app" temp-ipa/Payload/
          cd temp-ipa
          zip -qr "../SixOS_Simple.ipa" .
          cd ..
          echo "Created: SixOS_Simple.ipa"
        done

    # ===============================
    # UPLOAD ARTIFACTS
    # ===============================
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: iOS-Build-Output
        path: |
          *.ipa
          ./publish/
          ./bin/
        if-no-files-found: warn
        retention-days: 30

    # ===============================
    # DEBUG INFO
    # ===============================
    - name: Debug Information
      if: always()
      run: |
        echo "=== DEBUG INFORMATION ==="
        echo ""
        echo "1. .NET Version: $(dotnet --version)"
        echo ""
        echo "2. Project File:"
        head -40 SixOSDatKhamAppMobile.csproj
        echo ""
        echo "3. Global.json:"
        cat global.json 2>/dev/null || echo "No global.json"
        echo ""
        echo "4. Directory Tree:"
        find . -maxdepth 3 -type f \( -name "*.csproj" -o -name "*.sln" -o -name "*.ipa" -o -name "*.app" \) 2>/dev/null
