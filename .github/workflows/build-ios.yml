name: Build iOS with Code Signing

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ===============================
    # SETUP DOTNET 9.0 + MAUI
    # ===============================
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Install MAUI workloads
      run: |
        dotnet workload install maui
        dotnet workload install maui-ios
        dotnet workload update maui

    # ===============================
    # KEYCHAIN + CERT + PROFILE
    # ===============================
    - name: Create keychain and import certificates
      env:
        SIGNING_CERTIFICATE: ${{ secrets.SIGNING_CERTIFICATE }}
        SIGNING_CERTIFICATE_PASSWORD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
      run: |
        set -e
        
        echo "âœ… Creating keychain..."
        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        
        # Import certificate
        echo "Importing certificate..."
        echo "$SIGNING_CERTIFICATE" | base64 --decode > certificate.p12
        security import certificate.p12 \
          -k build.keychain \
          -P "$SIGNING_CERTIFICATE_PASSWORD" \
          -T /usr/bin/codesign \
          -A
        
        security set-key-partition-list \
          -S apple-tool:,apple:,codesign: \
          -s -k "" build.keychain
        
        echo "ðŸ” Available signing identities:"
        security find-identity -v -p codesigning build.keychain || true
        
        # Import provisioning profile
        echo "Importing provisioning profile..."
        echo "$PROVISIONING_PROFILE" | base64 --decode > profile.mobileprovision
        
        # Try to extract UUID
        UUID=""
        if command -v /usr/libexec/PlistBuddy &> /dev/null; then
          UUID=$(/usr/libexec/PlistBuddy -c 'Print UUID' /dev/stdin <<< $(security cms -D -i profile.mobileprovision 2>/dev/null) 2>/dev/null || echo "")
        fi
        
        if [ -z "$UUID" ]; then
          UUID="ios-profile-$(date +%s)"
        fi
        
        echo "Profile UUID: $UUID"
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp profile.mobileprovision \
          ~/Library/MobileDevice/Provisioning\ Profiles/"$UUID.mobileprovision"

    # ===============================
    # BUILD IOS - PHÆ¯Æ NG PHÃP 1: MSBuild
    # ===============================
    - name: Build iOS with MSBuild
      env:
        APPLE_TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        echo "Team ID: $APPLE_TEAM_ID"
        echo "Current directory: $(pwd)"
        
        # Clean
        rm -rf bin obj publish || true
        
        # Táº¡o thÆ° má»¥c output
        mkdir -p ipa-output
        
        # QUAN TRá»ŒNG: DÃ¹ng msbuild trá»±c tiáº¿p
        echo "Building with MSBuild..."
        
        # TrÆ°á»›c tiÃªn, restore Ä‘áº§y Ä‘á»§
        dotnet restore SixOSDatKhamAppMobile.csproj
        
        # Build vá»›i MSBuild
        msbuild SixOSDatKhamAppMobile.csproj \
          /t:Restore,Build \
          /p:Configuration=Release \
          /p:Platform=iPhone \
          /p:TargetFramework=net9.0-ios \
          /p:RuntimeIdentifier=ios-arm64 \
          /p:BuildIpa=true \
          /p:ArchiveOnBuild=false \
          /p:DevelopmentTeam="$APPLE_TEAM_ID" \
          /p:CodesignKey="Apple Development" \
          /p:ServerAddress=127.0.0.1 \
          /p:ServerUser=runner \
          /p:IpaPackageDir="$(pwd)/ipa-output" \
          /p:CreatePackage=true \
          /p:EnableCodeSigning=true \
          /p:TreatWarningsAsErrors=false \
          /p:MtouchLink=SdkOnly \
          /verbosity:detailed
        
        echo "âœ… MSBuild completed."
        
        # Kiá»ƒm tra output
        echo "=== Checking for IPA ==="
        find . -name "*.ipa" -type f 2>/dev/null || echo "No IPA files found"
        
        echo "=== Checking bin directory ==="
        find ./bin -type f \( -name "*.ipa" -o -name "*.app" \) 2>/dev/null || echo "No IPA or APP files in bin"

    # ===============================
    # PHÆ¯Æ NG PHÃP 2: Náº¿u phÆ°Æ¡ng phÃ¡p 1 khÃ´ng hoáº¡t Ä‘á»™ng
    # ===============================
    - name: Try Dotnet Publish Method
      if: failure()
      env:
        APPLE_TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        echo "Trying dotnet publish method..."
        
        # Clean
        rm -rf bin obj publish-ios || true
        
        # DÃ¹ng dotnet publish
        dotnet publish SixOSDatKhamAppMobile.csproj \
          -f net9.0-ios \
          -c Release \
          -p:Platform=iPhone \
          -p:RuntimeIdentifier=ios-arm64 \
          -p:BuildIpa=true \
          -p:IpaPackageDir="$(pwd)/publish-ios" \
          -p:DevelopmentTeam="$APPLE_TEAM_ID" \
          -p:CodesignKey="Apple Development" \
          -p:MtouchLink=SdkOnly \
          -p:EnableCodeSigning=true \
          -p:CreatePackage=true \
          -p:ServerAddress=127.0.0.1 \
          -p:ServerUser=runner \
          -o ./publish-ios \
          --verbosity detailed
        
        echo "Checking publish output..."
        find ./publish-ios -name "*.ipa" -type f 2>/dev/null || echo "No IPA in publish-ios"

    # ===============================
    # PHÆ¯Æ NG PHÃP 3: Build riÃªng app rá»“i táº¡o IPA
    # ===============================
    - name: Manual IPA Creation
      if: failure()
      env:
        APPLE_TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        echo "Trying manual IPA creation..."
        
        # Build app trÆ°á»›c
        dotnet build SixOSDatKhamAppMobile.csproj \
          -f net9.0-ios \
          -c Release \
          -p:Platform=iPhone \
          -p:RuntimeIdentifier=ios-arm64 \
          -p:DevelopmentTeam="$APPLE_TEAM_ID" \
          -p:CodesignKey="Apple Development" \
          -p:MtouchLink=SdkOnly
        
        # TÃ¬m file .app
        APP_PATH=$(find ./bin -name "*.app" -type d | head -1)
        
        if [ -n "$APP_PATH" ]; then
          echo "Found app at: $APP_PATH"
          
          # Táº¡o thÆ° má»¥c Payload
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/
          
          # Táº¡o IPA
          zip -r app.ipa Payload
          
          echo "Created IPA manually"
          ls -la app.ipa
        else
          echo "No .app file found"
          echo "Searching for build outputs..."
          find ./bin -type f -name "*.dll" -o -name "*.exe" | head -20
        fi

    # ===============================
    # KIá»‚M TRA PROJECT STRUCTURE
    # ===============================
    - name: Check Project Configuration
      if: always()
      run: |
        echo "=== PROJECT CONFIGURATION ==="
        
        # Kiá»ƒm tra csproj
        echo "CSProj content (first 100 lines):"
        head -100 SixOSDatKhamAppMobile.csproj
        
        echo ""
        echo "=== Check for iOS specific settings ==="
        grep -i "ios\|iphone\|apple\|provisioning\|signing" SixOSDatKhamAppMobile.csproj || true
        
        echo ""
        echo "=== Check target frameworks ==="
        grep -i "targetframework" SixOSDatKhamAppMobile.csproj || true
        
        echo ""
        echo "=== Check for app bundle settings ==="
        grep -i "bundle\|applicationid\|appname" SixOSDatKhamAppMobile.csproj || true

    # ===============================
    # UPLOAD ANY BUILD OUTPUTS
    # ===============================
    - name: Upload All Build Outputs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: iOS-Build-Debug
        path: |
          ./*.ipa
          ./bin/
          ./obj/
          ./publish*/
          ./ipa*/
          ./Payload/
        if-no-files-found: warn
        retention-days: 30

    # ===============================
    # CLEANUP
    # ===============================
    - name: Cleanup keychain
      if: always()
      run: |
        echo "Cleaning up keychain..."
        security delete-keychain build.keychain 2>/dev/null || true
