name: Build iOS IPA

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - '**/*.cs'
      - '**/*.xaml'
      - '**/*.csproj'

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET 8
      run: |
        # Cài .NET 8 SDK
        curl -L https://dot.net/v1/dotnet-install.sh | bash -s -- --version 8.0.401 --install-dir /usr/local/share/dotnet
        echo "/usr/local/share/dotnet" >> $GITHUB_PATH
        
        # Cài workloads MAUI
        /usr/local/share/dotnet/dotnet workload install maui
        /usr/local/share/dotnet/dotnet workload install maui-ios

    - name: Verify setup
      run: |
        dotnet --info
        dotnet workload list

    - name: Restore packages
      run: dotnet restore SixOSDatKhamAppMobile.csproj

    - name: Build IPA
      run: |
        dotnet publish SixOSDatKhamAppMobile.csproj \
          -f:net8.0-ios \
          -c:Release \
          -p:RuntimeIdentifier=ios-arm64 \
          -p:BuildIpa=true \
          -p:ArchiveOnBuild=true \
          -p:CodesignKey="iPhone Distribution" \
          -p:CodesignProvision="Automatic:Provisioning" \
          -p:MtouchLink=SdkOnly \
          -p:SkipSimulatorArchitectures=true \
          -p:TreatWarningsAsErrors=false \
          --verbosity:diagnostic \
          -o:./publish

    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: SixOS-iOS-IPA
        path: |
          ./publish/*.ipa
          ./publish/*.app
        retention-days: 7
