name: Build iOS IPA

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-ipa:
    runs-on: macos-latest
    
    env:
      DOTNET_VERSION: '9.0.x'
      MAUI_VERSION: '9.0.0'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ===============================
    # SETUP .NET & MAUI
    # ===============================
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Install MAUI Workloads
      run: |
        echo "=== INSTALLING MAUI WORKLOADS ==="
        sudo dotnet workload install maui
        sudo dotnet workload install ios
        dotnet workload list

    - name: Display .NET Info
      run: |
        echo "=== .NET INFORMATION ==="
        dotnet --info
        echo ""
        echo "=== SDKS ==="
        ls -la /usr/local/share/dotnet/sdk/

    # ===============================
    # RESTORE PACKAGES
    # ===============================
    - name: Restore NuGet Packages
      run: |
        echo "=== RESTORING PACKAGES ==="
        dotnet restore SixOSDatKhamAppMobile.csproj --verbosity normal
        
        echo "âœ… Restore completed"
        echo ""
        echo "Project structure:"
        ls -la

    # ===============================
    # SIMPLE CODE SIGNING SETUP
    # ===============================
    - name: Setup Basic Code Signing
      run: |
        echo "=== SETUP BASIC CODE SIGNING ==="
        
        # Táº¡o keychain táº¡m
        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        
        # Táº¡o certificate tá»± kÃ½ Ä‘Æ¡n giáº£n
        openssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem -days 365 -nodes -subj "/CN=iOS Development"
        openssl pkcs12 -export -out cert.p12 -inkey key.pem -in cert.pem -password pass:password
        
        # Import vÃ o keychain
        security import cert.p12 -k build.keychain -P password -T /usr/bin/codesign
        
        # Cáº¥u hÃ¬nh keychain
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain
        
        echo "âœ… Code signing identities:"
        security find-identity -v -p codesigning build.keychain || true

    # ===============================
    # BUILD FOR SIMULATOR (TEST)
    # ===============================
    - name: Build for Simulator
      run: |
        echo "=== BUILDING FOR SIMULATOR ==="
        
        # Clean
        dotnet clean SixOSDatKhamAppMobile.csproj -c Debug
        
        # Build simulator
        dotnet build SixOSDatKhamAppMobile.csproj \
          -f net9.0-ios \
          -c Debug \
          -p:RuntimeIdentifier=ios-x64 \
          -p:Platform=iPhoneSimulator \
          -p:BuildIpa=false \
          --verbosity normal
        
        echo "âœ… Simulator build completed"
        echo ""
        echo "Simulator output:"
        find ./bin -name "*.dll" -type f | head -5 || true

    # ===============================
    # BUILD FOR DEVICE (NO COMPLEX SIGNING)
    # ===============================
    - name: Build Device Version
      run: |
        echo "=== BUILDING FOR DEVICE ==="
        
        # Clean release
        rm -rf bin/Release net9.0-ios/ obj/Release/ publish/ ipa-output/ || true
        
        echo "Building with minimal properties..."
        
        # Build Ä‘Æ¡n giáº£n vá»›i code signing cÆ¡ báº£n
        dotnet publish SixOSDatKhamAppMobile.csproj \
          -f net9.0-ios \
          -c Release \
          -p:RuntimeIdentifier=ios-arm64 \
          -p:Platform=iPhone \
          -p:BuildIpa=true \
          -p:ArchiveOnBuild=true \
          -p:CreatePackage=true \
          -p:EnableCodeSigning=true \
          -p:CodesignKey="" \
          -p:DevelopmentTeam="" \
          -p:ProvisioningType=ad-hoc \
          -p:IpaPackageDir="$(pwd)/ipa-output" \
          -o ./publish \
          --verbosity normal
        
        echo "=== BUILD COMPLETED ==="

    # ===============================
    # CHECK BUILD RESULTS
    # ===============================
    - name: Check Build Output
      run: |
        echo "=== CHECKING BUILD OUTPUT ==="
        
        echo "1. All files in current directory:"
        ls -la
        
        echo ""
        echo "2. IPA files:"
        find . -name "*.ipa" -type f 2>/dev/null | while read ipa; do
          echo "ðŸ“¦ IPA: $ipa"
          echo "   Size: $(du -h "$ipa" | cut -f1)"
          echo ""
        done || echo "No IPA files found"
        
        echo ""
        echo "3. App bundles:"
        find . -name "*.app" -type d 2>/dev/null | while read app; do
          echo "ðŸ“± App: $app"
          echo "   Size: $(du -sh "$app" | cut -f1)"
          echo "   Contents:"
          ls -la "$app" | head -10
          echo ""
        done || echo "No app bundles found"
        
        echo ""
        echo "4. Build directories:"
        ls -la ./bin/ ./publish/ ./ipa-output/ 2>/dev/null || true

    # ===============================
    # CREATE IPA MANUALLY IF NEEDED
    # ===============================
    - name: Create Manual IPA
      if: success() || failure()
      run: |
        echo "=== CREATING MANUAL IPA (IF NEEDED) ==="
        
        # TÃ¬m app bundle
        APP_BUNDLE=$(find ./bin -name "*.app" -type d 2>/dev/null | grep -i release | head -1)
        
        if [ -z "$APP_BUNDLE" ]; then
          APP_BUNDLE=$(find . -name "*.app" -type d 2>/dev/null | head -1)
        fi
        
        if [ ! -z "$APP_BUNDLE" ]; then
          echo "Found app bundle: $APP_BUNDLE"
          
          # Táº¡o thÆ° má»¥c IPA
          IPA_DIR="manual-ipa"
          rm -rf "$IPA_DIR" || true
          mkdir -p "$IPA_DIR/Payload"
          
          # Copy app bundle
          cp -R "$APP_BUNDLE" "$IPA_DIR/Payload/"
          
          # Táº¡o IPA
          cd "$IPA_DIR"
          zip -qr "../SixOS_Manual.ipa" .
          cd ..
          
          echo "âœ… Created manual IPA: SixOS_Manual.ipa"
          ls -la *.ipa
        else
          echo "âš ï¸ No app bundle found for manual IPA creation"
          
          # Kiá»ƒm tra bin directory
          echo "Checking bin directory structure:"
          find ./bin -type f | head -20 || true
        fi

    # ===============================
    # DEBUG INFO
    # ===============================
    - name: Debug Information
      if: always()
      run: |
        echo "=== DEBUG INFORMATION ==="
        echo ""
        echo "1. Project file check:"
        head -50 SixOSDatKhamAppMobile.csproj
        echo ""
        echo "2. Directory structure:"
        find . -maxdepth 2 -type d | sort
        echo ""
        echo "3. .NET workloads:"
        dotnet workload list

    # ===============================
    # UPLOAD ARTIFACTS
    # ===============================
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: iOS-Build-Artifacts
        path: |
          *.ipa
          ./ipa-output/
          ./publish/
          ./bin/
        if-no-files-found: warn
        retention-days: 30

    # ===============================
    # CLEANUP
    # ===============================
    - name: Cleanup
      if: always()
      run: |
        echo "=== CLEANUP ==="
        security delete-keychain build.keychain 2>/dev/null || true
        rm -f key.pem cert.pem cert.p12 2>/dev/null || true
