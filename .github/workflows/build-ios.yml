name: Build iOS/Mac Catalyst IPA (.NET 7 MAUI)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout mã nguồn
      uses: actions/checkout@v4

    - name: Cài đặt .NET 7 SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '7.0.x'

    - name: Hiển thị thông tin hệ thống
      run: |
        echo "=== Thông tin hệ thống ==="
        uname -a
        sw_vers
        xcodebuild -version
        echo "=== Thông tin .NET ==="
        dotnet --info

    - name: Cài đặt workloads MAUI cho .NET 7
      run: |
        echo "=== Cài đặt workloads cần thiết ==="
        
        # Cài đặt MAUI workload cho .NET 7
        echo "1. Cài đặt MAUI workload..."
        dotnet workload install maui-ios maui-maccatalyst
        
        echo "=== Danh sách workloads đã cài đặt ==="
        dotnet workload list

    - name: Khôi phục dependencies
      run: |
        echo "=== Đang restore dependencies ==="
        dotnet restore --verbosity normal

    - name: Build cho iOS (.NET 7) - Tạo IPA
      run: |
        echo "=== Building cho iOS (.NET 7) - Tạo IPA ==="
        
        # Build iOS để tạo IPA
        dotnet publish SixOSDatKhamAppMobile.csproj \
          -f net7.0-ios \
          -c Release \
          -r ios-arm64 \
          -p:BuildIpa=true \
          -p:ArchiveOnBuild=true \
          -p:EnableCodeSigning=false \
          -p:EnablePackageSigning=false \
          -p:MtouchLink=SdkOnly \
          --verbosity normal
        
        echo "=== Đã build iOS IPA xong ==="

    - name: Build cho Mac Catalyst (.NET 7)
      run: |
        echo "=== Building cho Mac Catalyst (.NET 7) ==="
        
        # Build với Mac Catalyst
        dotnet publish SixOSDatKhamAppMobile.csproj \
          -f net7.0-maccatalyst \
          -c Release \
          -r maccatalyst-x64 \
          -p:MtouchLink=SdkOnly \
          -p:CreatePackage=true \
          --verbosity normal
        
        echo "=== Đã build Mac Catalyst xong ==="

    - name: Tìm và liệt kê file output
      run: |
        echo "=== Tìm file .ipa cho iOS ==="
        find . -name "*.ipa" -type f 2>/dev/null || echo "Không tìm thấy file .ipa"
        
        echo "=== Tìm file .app cho Mac Catalyst ==="
        find . -name "*.app" -type d 2>/dev/null || echo "Không tìm thấy file .app"
        
        echo "=== Cấu trúc thư mục bin ==="
        ls -la bin/Release/ || true
        find bin/Release -type f -name "*.ipa" -o -name "*.app" 2>/dev/null || true

    - name: Upload file IPA iOS
      uses: actions/upload-artifact@v4
      with:
        name: ios-ipa
        path: |
          **/bin/Release/net7.0-ios/ios-arm64/*.ipa
          **/bin/Release/**/*.ipa
        if-no-files-found: warn

    - name: Upload file .app Mac Catalyst
      uses: actions/upload-artifact@v4
      with:
        name: mac-catalyst-app
        path: |
          **/bin/Release/net7.0-maccatalyst/maccatalyst-x64/*.app
          **/bin/Release/**/*.app
        if-no-files-found: warn
