name: Build iOS IPA (.NET 8 MAUI)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout mã nguồn
      uses: actions/checkout@v4

    - name: Cài đặt .NET 8 SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Hiển thị thông tin dotnet (debug)
      run: dotnet --info

    - name: Cài đặt và cập nhật workloads MAUI
      run: |
        # Kiểm tra workloads hiện có
        echo "=== Danh sách workloads hiện tại ==="
        dotnet workload list
        
        # Cập nhật workload manifests
        echo "=== Đang cập nhật workload manifests ==="
        dotnet workload update
        
        # Cài đặt MAUI workload (bao gồm iOS, Android)
        echo "=== Đang cài đặt MAUI workload ==="
        dotnet workload install maui
        
        # Kiểm tra lại
        echo "=== Danh sách workloads sau khi cài đặt ==="
        dotnet workload list

    - name: Khôi phục dependencies
      run: dotnet restore

    - name: Build IPA (chưa ký)
      run: |
        echo "=== Đang build project iOS ==="
        echo "Tìm file .csproj..."
        find . -name "*.csproj" -type f
        
        # Build với target framework đúng cho MAUI iOS
        dotnet publish \
          -f net8.0-maccatalyst \
          -c Release \
          -p:BuildIpa=true \
          -p:ArchiveOnBuild=true \
          -p:MtouchLink=SdkOnly \
          --verbosity detailed

    - name: Tìm và upload file IPA
      run: |
        echo "=== Tìm file IPA ==="
        find . -name "*.ipa" -type f 2>/dev/null || true
        echo "=== Nội dung thư mục ==="
        ls -la bin/Release/ 2>/dev/null || true
        ls -la bin/Release/net8.0-maccatalyst/ 2>/dev/null || true

    - name: Upload file IPA
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ios-ipa
        path: |
          **/bin/Release/**/*.ipa
          **/*.ipa
        if-no-files-found: warn
