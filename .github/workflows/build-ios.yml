name: Build iOS with Code Signing

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ===============================
    # SETUP DOTNET 9.0
    # ===============================
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Install MAUI workloads
      run: |
        dotnet workload install maui
        dotnet workload install maui-ios

    # ===============================
    # KEYCHAIN + CERT + PROFILE
    # ===============================
    - name: Create keychain and import certificates
      env:
        SIGNING_CERTIFICATE: ${{ secrets.SIGNING_CERTIFICATE }}
        SIGNING_CERTIFICATE_PASSWORD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
      run: |
        set -e
        
        echo "âœ… Creating keychain..."
        
        # Create keychain
        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        
        # Import certificate
        echo "Importing certificate..."
        echo "$SIGNING_CERTIFICATE" | base64 --decode > certificate.p12
        security import certificate.p12 \
          -k build.keychain \
          -P "$SIGNING_CERTIFICATE_PASSWORD" \
          -T /usr/bin/codesign \
          -A
        
        security set-key-partition-list \
          -S apple-tool:,apple:,codesign: \
          -s -k "" build.keychain
        
        echo "ðŸ” Available signing identities:"
        security find-identity -v -p codesigning build.keychain || true
        
        # Import provisioning profile
        echo "Importing provisioning profile..."
        echo "$PROVISIONING_PROFILE" | base64 --decode > profile.mobileprovision
        
        # Extract UUID from provisioning profile
        UUID=$(/usr/libexec/PlistBuddy -c 'Print UUID' /dev/stdin <<< $(security cms -D -i profile.mobileprovision 2>/dev/null) 2>/dev/null || echo "")
        
        if [ -z "$UUID" ]; then
          echo "âš ï¸ Could not extract UUID, using timestamp"
          UUID="ios-profile-$(date +%s)"
        fi
        
        echo "Profile UUID: $UUID"
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp profile.mobileprovision \
          ~/Library/MobileDevice/Provisioning\ Profiles/"$UUID.mobileprovision"
        
        echo "âœ… Installed provisioning profiles:"
        ls -la ~/Library/MobileDevice/Provisioning\ Profiles/

    # ===============================
    # BUILD IOS APP
    # ===============================
    - name: Build iOS App
      env:
        APPLE_TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        echo "Team ID: $APPLE_TEAM_ID"
        echo "Current directory: $(pwd)"
        
        # Clean
        rm -rf bin obj publish ipa-output || true
        
        # Restore packages
        echo "Restoring packages..."
        dotnet restore SixOSDatKhamAppMobile.csproj
        
        # Táº¡o thÆ° má»¥c output
        mkdir -p ipa-output
        
        # QUAN TRá»ŒNG: Build vá»›i cÃ¡c tham sá»‘ Ä‘Ãºng
        echo "Building iOS app with IPA..."
        dotnet build SixOSDatKhamAppMobile.csproj \
          -f net9.0-ios \
          -c Release \
          -p:Platform=iPhone \
          -p:RuntimeIdentifier=ios-arm64 \
          -p:BuildIpa=true \
          -p:ArchiveOnBuild=false \
          -p:DevelopmentTeam="$APPLE_TEAM_ID" \
          -p:CodesignKey="Apple Development" \
          -p:MtouchLink=SdkOnly \
          -p:IpaPackageDir="$(pwd)/ipa-output" \
          -p:CreatePackage=true \
          -p:EnableCodeSigning=true \
          -p:TreatWarningsAsErrors=false \
          --verbosity diagnostic
        
        echo "âœ… Build completed. Checking for IPA..."
        
        # Kiá»ƒm tra file IPA
        if ls ipa-output/*.ipa 1>/dev/null 2>&1; then
          echo "ðŸŽ‰ IPA file found!"
          ls -la ipa-output/*.ipa
          
          # Hiá»ƒn thá»‹ thÃ´ng tin vá» IPA
          echo "IPA Info:"
          unzip -l ipa-output/*.ipa | grep Payload | head -5
        else
          echo "âŒ No IPA file found in ipa-output directory"
          echo "Contents of ipa-output:"
          ls -la ipa-output/ || true
          
          # TÃ¬m kiáº¿m á»Ÿ cÃ¡c vá»‹ trÃ­ khÃ¡c
          echo "Searching for IPA files in entire project..."
          find . -name "*.ipa" -type f 2>/dev/null || echo "No IPA files found anywhere"
          
          # Kiá»ƒm tra thÆ° má»¥c bin
          echo "Checking bin directory structure..."
          find ./bin -type f -name "*.app" -o -name "*.ipa" 2>/dev/null | head -20
        fi

    # ===============================
    # Náº¾U CÃCH 1 KHÃ”NG HOáº T Äá»˜NG, THá»¬ CÃCH 2
    # ===============================
    - name: Alternative Build Method
      if: failure()
      env:
        APPLE_TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        echo "Trying alternative build method..."
        
        # Clean
        rm -rf bin obj || true
        
        # PhÆ°Æ¡ng phÃ¡p 2: Build riÃªng biá»‡t
        echo "Step 1: Build project"
        dotnet build SixOSDatKhamAppMobile.csproj \
          -f net9.0-ios \
          -c Release \
          -p:Platform=iPhone \
          -p:RuntimeIdentifier=ios-arm64
        
        echo "Step 2: Publish with IPA"
        dotnet publish SixOSDatKhamAppMobile.csproj \
          -f net9.0-ios \
          -c Release \
          -p:Platform=iPhone \
          -p:RuntimeIdentifier=ios-arm64 \
          -p:BuildIpa=true \
          -p:IpaPackageDir="$(pwd)/ipa-output-2" \
          -p:DevelopmentTeam="$APPLE_TEAM_ID" \
          -p:CodesignKey="Apple Development" \
          -o ./publish-ios
        
        echo "Checking output..."
        find . -name "*.ipa" -type f 2>/dev/null || echo "No IPA files found"

    # ===============================
    # UPLOAD ARTIFACTS
    # ===============================
    - name: Upload Build Artifacts
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: iOS-Build-Artifacts
        path: |
          ./ipa-output/
          ./ipa-output-2/
          ./publish/
          ./publish-ios/
          ./bin/Release/net9.0-ios/
        if-no-files-found: warn
        retention-days: 30

    # ===============================
    # DEBUG INFO
    # ===============================
    - name: Collect Debug Information
      if: always()
      run: |
        echo "=== DEBUG INFORMATION ==="
        echo "Project file content:"
        head -50 SixOSDatKhamAppMobile.csproj || true
        
        echo "Directory structure:"
        find . -type f -name "*.csproj" -o -name "*.sln" | head -20
        
        echo ".NET SDK info:"
        dotnet --info
        
        echo "MAUI workloads:"
        dotnet workload list

    # ===============================
    # CLEANUP
    # ===============================
    - name: Cleanup keychain
      if: always()
      run: |
        echo "Cleaning up keychain..."
        security delete-keychain build.keychain 2>/dev/null || true
