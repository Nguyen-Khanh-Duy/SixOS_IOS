name: Build iOS with Code Signing

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ===============================
    # SETUP DOTNET 9.0
    # ===============================
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Install MAUI workloads
      run: |
        dotnet workload install maui
        dotnet workload install maui-ios

    # ===============================
    # DEBUG SECRETS
    # ===============================
    - name: Debug Secrets
      env:
        SIGNING_CERTIFICATE: ${{ secrets.SIGNING_CERTIFICATE }}
        SIGNING_CERTIFICATE_PASSWORD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
        TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        echo "SIGNING_CERTIFICATE length: ${#SIGNING_CERTIFICATE}"
        echo "SIGNING_CERTIFICATE_PASSWORD: ${SIGNING_CERTIFICATE_PASSWORD:+SET}"
        echo "PROVISIONING_PROFILE length: ${#PROVISIONING_PROFILE}"
        echo "TEAM_ID: $TEAM_ID"
        
        if [ -z "$SIGNING_CERTIFICATE" ]; then
          echo "‚ùå SIGNING_CERTIFICATE is empty!"
        fi
        if [ -z "$PROVISIONING_PROFILE" ]; then
          echo "‚ùå PROVISIONING_PROFILE is empty!"
        fi
        if [ -z "$TEAM_ID" ]; then
          echo "‚ùå TEAM_ID is empty!"
        fi

    # ===============================
    # KEYCHAIN + CERT + PROFILE
    # ===============================
    - name: Create keychain and import certificates
      env:
        SIGNING_CERTIFICATE: ${{ secrets.SIGNING_CERTIFICATE }}
        SIGNING_CERTIFICATE_PASSWORD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
      run: |
        set -e
        
        echo "‚úÖ Creating keychain..."
        
        # Create keychain
        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain

        # ===============================
        # IMPORT CERTIFICATE
        # ===============================
        echo "Importing certificate..."
        echo "$SIGNING_CERTIFICATE" | base64 --decode > certificate.p12

        security import certificate.p12 \
          -k build.keychain \
          -P "$SIGNING_CERTIFICATE_PASSWORD" \
          -T /usr/bin/codesign \
          -A

        security set-key-partition-list \
          -S apple-tool:,apple:,codesign: \
          -s -k "" build.keychain

        echo "üîç Available signing identities:"
        security find-identity -v -p codesigning build.keychain || true

        # ===============================
        # IMPORT PROVISIONING PROFILE
        # ===============================
        echo "Importing provisioning profile..."
        echo "$PROVISIONING_PROFILE" | base64 --decode > profile.mobileprovision

        # Extract UUID from provisioning profile
        echo "Extracting UUID..."
        UUID=$(/usr/libexec/PlistBuddy -c 'Print UUID' /dev/stdin <<< $(security cms -D -i profile.mobileprovision 2>/dev/null) 2>/dev/null)
        
        if [ -z "$UUID" ]; then
          echo "‚ö†Ô∏è Trying alternative method to extract UUID..."
          UUID=$(strings profile.mobileprovision | grep -i "uuid" | head -1 | sed -e 's/.*<string>\(.*\)<\/string>.*/\1/' -e 's/.*UUID = \(.*\);/\1/' | tr -d ' ')
        fi
        
        if [ -z "$UUID" ]; then
          echo "‚ö†Ô∏è Using fixed UUID for development"
          UUID="dev-profile-$(date +%s)"
        fi

        echo "Profile UUID: $UUID"

        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp profile.mobileprovision \
          ~/Library/MobileDevice/Provisioning\ Profiles/"$UUID.mobileprovision"

        echo "‚úÖ Installed provisioning profiles:"
        ls -la ~/Library/MobileDevice/Provisioning\ Profiles/

    # ===============================
    # BUILD IOS (DEV SIGNING)
    # ===============================
    - name: Build iOS App
      env:
        APPLE_TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        echo "Team ID: $APPLE_TEAM_ID"
        echo "Current directory: $(pwd)"
        
        # Clean manual thay v√¨ d√πng dotnet clean
        echo "Cleaning bin and obj directories..."
        rm -rf bin obj publish ipa-output || true
        
        # Restore packages
        echo "Restoring packages..."
        dotnet restore SixOSDatKhamAppMobile.csproj
        
        # Build command v·ªõi output r√µ r√†ng
        echo "Building app..."
        dotnet publish SixOSDatKhamAppMobile.csproj \
          -f net9.0-ios \
          -c Release \
          -p:RuntimeIdentifier=ios-arm64 \
          -p:BuildIpa=true \
          -p:ArchiveOnBuild=true \
          -p:DevelopmentTeam="$APPLE_TEAM_ID" \
          -p:CodesignKey="Apple Distribution" \
          -p:MtouchLink=SdkOnly \
          -p:IpaPackageDir="$(pwd)/ipa-output" \
          -p:CreatePackage=true \
          -p:EnableCodeSigning=true \
          -p:CodesignEntitlements="" \
          -p:CodesignProvision="" \
          -p:CodesignResourceRules="" \
          -o ./publish \
          --verbosity detailed
        
        echo "‚úÖ Build completed. Checking output..."
        
        # Ki·ªÉm tra c√°c v·ªã tr√≠ c√≥ th·ªÉ c√≥ IPA
        echo "=== Searching for IPA files ==="
        
        # 1. Ki·ªÉm tra th∆∞ m·ª•c ipa-output
        echo "1. Checking ipa-output directory:"
        if [ -d "./ipa-output" ]; then
          ls -la ./ipa-output/
          find ./ipa-output -name "*.ipa" -type f 2>/dev/null
        else
          echo "ipa-output directory not found"
        fi
        
        # 2. Ki·ªÉm tra th∆∞ m·ª•c publish
        echo "2. Checking publish directory:"
        if [ -d "./publish" ]; then
          ls -la ./publish/
          find ./publish -name "*.ipa" -type f 2>/dev/null
        else
          echo "publish directory not found"
        fi
        
        # 3. Ki·ªÉm tra th∆∞ m·ª•c bin
        echo "3. Checking bin directory:"
        if [ -d "./bin" ]; then
          find ./bin -name "*.ipa" -type f 2>/dev/null
        fi
        
        # 4. Ki·ªÉm tra to√†n b·ªô project
        echo "4. Searching recursively for IPA files:"
        find . -name "*.ipa" -type f 2>/dev/null || echo "No IPA files found"
        
        # 5. Ki·ªÉm tra c√°c th∆∞ m·ª•c build iOS ph·ªï bi·∫øn
        echo "5. Checking iOS build directories:"
        find . -path "*/bin/*ios*/*" -name "*.ipa" -type f 2>/dev/null
        
        # 6. T√¨m file .app bundle (c√≥ th·ªÉ ch∆∞a ƒë∆∞·ª£c ƒë√≥ng g√≥i th√†nh IPA)
        echo "6. Looking for .app bundles:"
        find . -name "*.app" -type d 2>/dev/null | head -10
        
        # 7. Ki·ªÉm tra th∆∞ m·ª•c c·ª• th·ªÉ c·ªßa .NET MAUI iOS
        echo "7. Checking .NET MAUI iOS specific directories:"
        IOS_BUILD_DIR="./bin/Release/net9.0-ios/ios-arm64"
        if [ -d "$IOS_BUILD_DIR" ]; then
          echo "iOS build directory exists:"
          ls -la "$IOS_BUILD_DIR/"
          
          # Ki·ªÉm tra Archive
          if [ -d "$IOS_BUILD_DIR/Archive" ]; then
            echo "Archive directory found:"
            find "$IOS_BUILD_DIR/Archive" -name "*.ipa" -type f 2>/dev/null
          fi
          
          # Ki·ªÉm tra Packages
          if [ -d "$IOS_BUILD_DIR/Packages" ]; then
            echo "Packages directory found:"
            find "$IOS_BUILD_DIR/Packages" -name "*.ipa" -type f 2>/dev/null
          fi
        fi

    # ===============================
    # UPLOAD IPA HO·∫∂C APP
    # ===============================
    - name: Upload Build Artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: iOS-Build-Artifacts
        path: |
          ./ipa-output/
          ./publish/
          ./bin/Release/net9.0-ios/ios-arm64/
        if-no-files-found: warn
        retention-days: 7

    # ===============================
    # TH·ª¨ BUILD KH√îNG C√ì ArchiveOnBuild
    # ===============================
    - name: Try Alternative Build (without ArchiveOnBuild)
      if: failure()
      env:
        APPLE_TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        echo "Trying alternative build without ArchiveOnBuild..."
        
        # Clean
        rm -rf bin obj publish ipa-output alt-build || true
        
        # Build kh√¥ng c√≥ ArchiveOnBuild
        dotnet publish SixOSDatKhamAppMobile.csproj \
          -f net9.0-ios \
          -c Release \
          -p:RuntimeIdentifier=ios-arm64 \
          -p:BuildIpa=true \
          -p:DevelopmentTeam="$APPLE_TEAM_ID" \
          -p:CodesignKey="Apple Development" \
          -p:MtouchLink=SdkOnly \
          -p:IpaPackageDir="$(pwd)/alt-build" \
          -p:CreatePackage=true \
          -o ./publish-alt
        
        echo "Checking alternative build output..."
        find . -name "*.ipa" -type f 2>/dev/null || echo "No IPA files found in alternative build"

    # ===============================
    # CLEANUP
    # ===============================
    - name: Cleanup keychain
      if: always()
      run: |
        echo "Cleaning up keychain..."
        security delete-keychain build.keychain 2>/dev/null || true
